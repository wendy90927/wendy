<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭物品管家</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 无障碍专用隐藏 */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* 强焦样式 */
        *:focus {
            outline: 4px solid #f97316; 
            outline-offset: 2px;
            z-index: 100;
        }

        /* 列表卡片 */
        .item-card:focus {
            border-color: #2563eb;
            background-color: #eff6ff;
            transform: scale(1.02);
        }

        /* 数量按钮 */
        .qty-btn {
            height: 60px;
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            background: white;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .qty-btn:hover, .qty-btn:focus {
            background-color: #dbeafe;
            border-color: #2563eb;
            color: #1e40af;
        }

        /* 自定义输入触发器 */
        .custom-input-trigger {
            flex-grow: 1;
            border: 2px solid #e5e7eb;
            padding: 0.5rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            cursor: pointer;
        }
        .custom-input-trigger:focus {
            border-color: #2563eb;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">

    <div id="live-announcer" class="sr-only" aria-live="polite"></div>

    <datalist id="unit-presets"></datalist>

    <div id="screen-login" class="screen min-h-screen flex flex-col justify-center items-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h1 id="title-login" class="text-3xl font-bold mb-8 text-center outline-none" tabindex="-1">家庭物品管家</h1>
            
            <label for="login-email" class="block mb-2 font-bold text-lg">邮箱账号</label>
            <input type="email" id="login-email" class="w-full p-4 border-2 border-gray-300 rounded-lg mb-6 text-lg" placeholder="name@email.com" aria-label="邮箱账号">
            
            <label for="login-password" class="block mb-2 font-bold text-lg">密码</label>
            <input type="password" id="login-password" class="w-full p-4 border-2 border-gray-300 rounded-lg mb-4 text-lg" placeholder="请输入密码" aria-label="密码">
            
            <div class="flex flex-col gap-3 mb-6">
                <label class="flex items-center gap-3 p-2 border rounded hover:bg-gray-50 cursor-pointer">
                    <input type="checkbox" id="chk-auto-login" class="w-6 h-6 text-blue-600" checked>
                    <span class="font-bold text-lg">自动登录</span>
                </label>
                <label class="flex items-center gap-3 p-2 border rounded hover:bg-gray-50 cursor-pointer">
                    <input type="checkbox" id="chk-remember-email" class="w-6 h-6 text-blue-600">
                    <span class="font-bold text-lg">记住账号</span>
                </label>
            </div>

            <button id="btn-login" class="w-full bg-blue-600 text-white p-4 rounded-lg font-bold text-xl hover:bg-blue-700 mb-4">登录</button>
            
            <div class="flex justify-between mt-4">
                <button id="btn-to-register" class="text-blue-700 font-bold hover:underline p-2">注册新账号</button>
                <button id="btn-forgot-pass" class="text-gray-600 font-bold hover:underline p-2">忘记密码?</button>
            </div>
        </div>
    </div>

    <div id="screen-register" class="screen hidden min-h-screen flex flex-col justify-center items-center p-4 bg-gray-50">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h1 id="title-register" class="text-2xl font-bold mb-6 text-center outline-none" tabindex="-1">注册新账号</h1>
            <label for="reg-email" class="block mb-2 font-bold text-lg">邮箱</label>
            <input type="email" id="reg-email" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 text-lg" aria-label="设置邮箱">
            <label for="reg-pass" class="block mb-2 font-bold text-lg">设置密码 (至少6位)</label>
            <input type="password" id="reg-pass" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 text-lg" aria-label="设置密码">
            <label for="reg-pass-confirm" class="block mb-2 font-bold text-lg">确认密码</label>
            <input type="password" id="reg-pass-confirm" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-8 text-lg" aria-label="确认密码">
            <button id="btn-submit-reg" class="w-full bg-green-600 text-white p-4 rounded-lg font-bold text-xl hover:bg-green-700 mb-4">确认注册</button>
            <button id="btn-back-login" class="w-full bg-gray-200 text-gray-800 p-3 rounded-lg font-bold text-lg">返回登录</button>
        </div>
    </div>

    <div id="screen-home" class="screen hidden min-h-screen flex flex-col pb-20">
        <header class="bg-blue-800 text-white p-4 shadow-md sticky top-0 z-20">
            <div class="max-w-3xl mx-auto flex flex-col gap-4">
                
                <div class="flex justify-between items-center mb-1 relative">
                    <h1 id="title-home" class="text-xl font-bold outline-none" tabindex="-1">物品管家</h1>
                    <button id="btn-account-menu" aria-haspopup="true" aria-expanded="false" class="text-sm bg-blue-900 hover:bg-blue-700 px-3 py-2 rounded border border-blue-500 font-bold flex items-center gap-2 focus:ring-2 ring-white">
                        <span id="user-email-display">账号</span>
                        <span aria-hidden="true">▼</span>
                    </button>
                    <div id="menu-account-dropdown" class="hidden absolute top-full right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 text-gray-900 z-50 flex flex-col">
                        <button id="btn-clear-data" class="w-full text-left px-4 py-4 hover:bg-red-50 text-red-700 font-bold border-b border-gray-200">清空所有数据</button>
                        <button id="btn-delete-account" class="w-full text-left px-4 py-4 hover:bg-red-50 text-red-700 font-bold border-b border-gray-200">注销账号</button>
                        <button id="btn-logout" class="w-full text-left px-4 py-4 hover:bg-gray-100 font-bold text-gray-800">退出登录</button>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button id="btn-nav-add" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-lg shadow text-xl border-2 border-green-400">+ 新增物品</button>
                    <button id="btn-nav-takeout" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-lg shadow text-xl border-2 border-orange-400">- 取出物品</button>
                </div>

                <button id="btn-nav-data" class="w-full bg-blue-700 hover:bg-blue-600 text-white py-3 rounded-lg border border-blue-400 font-bold">数据管理 (导入/导出)</button>

                <div class="flex gap-2">
                    <div class="relative flex-grow">
                        <label for="home-search" class="sr-only">搜索物品</label>
                        <input type="text" id="home-search" placeholder="输入内容搜索..." class="w-full p-3 text-black rounded shadow font-bold text-lg pr-10" aria-label="搜索物品">
                        
                        <button type="button" id="btn-clear-search" aria-label="清除搜索输入" 
                                class="absolute right-0 inset-y-0 w-10 flex items-center justify-center text-gray-400 hover:text-gray-600 focus:outline-none hidden" 
                                title="清除输入">
                            <svg class="h-5 w-5 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                <path d="M10 8.586L2.929 1.515 1.515 2.929 8.586 10l-7.071 7.071 1.414 1.414L10 11.414l7.071 7.071 1.414-1.414L11.414 10l7.071-7.071-1.414-1.414L10 8.586z"/>
                            </svg>
                        </button>
                    </div>
                    <button id="btn-do-search" class="bg-white text-blue-800 px-4 rounded font-bold shadow">搜索</button>
                </div>
                </div>
        </header>

        <section class="bg-white p-4 shadow-sm border-b z-10">
            <div class="max-w-3xl mx-auto flex items-center gap-2">
                <label for="home-filter" class="font-bold whitespace-nowrap text-lg">房间筛选：</label>
                <select id="home-filter" autocomplete="off" class="w-full p-3 border-2 border-gray-300 rounded bg-gray-50 text-lg font-bold text-black" aria-label="筛选房间">
                    <option value="all">全部房间</option>
                    <option value="客厅">客厅</option>
                    <option value="厨房">厨房</option>
                    <option value="卧室">卧室</option>
                    <option value="书房">书房</option>
                    <option value="餐厅">餐厅</option>
                    <option value="玄关">玄关</option>
                    <option value="卫生间">卫生间</option>
                    <option value="洗衣房">洗衣房</option>
                </select>
            </div>
        </section>

        <main class="flex-grow p-4 bg-gray-50">
            <div id="home-list" class="max-w-3xl mx-auto space-y-4" role="list" aria-label="物品列表"></div>
        </main>
    </div>

    <div id="screen-results" class="screen hidden min-h-screen flex flex-col bg-gray-100">
        <div class="bg-purple-700 text-white p-4 shadow-md sticky top-0 z-20">
            <div class="max-w-3xl mx-auto flex flex-col gap-4">
                <div class="flex items-center justify-between">
                    <button id="btn-back-results" class="bg-white text-purple-800 px-6 py-2 rounded-lg font-bold border-2 border-purple-200">&lt; 返回首页</button>
                    <h1 id="title-results" class="text-xl font-bold outline-none" tabindex="-1">搜索结果</h1>
                </div>
            </div>
        </div>

        <main class="flex-grow p-4 bg-gray-50 overflow-y-auto">
            <div id="results-stats" class="max-w-3xl mx-auto mb-4 p-4 bg-purple-50 border-l-4 border-purple-500 rounded shadow text-lg font-bold" aria-live="polite">
                正在计算...
            </div>
            <div id="results-list" class="max-w-3xl mx-auto space-y-4" role="list" aria-label="搜索结果列表"></div>
        </main>
    </div>

    <div id="screen-add" class="screen hidden min-h-screen flex flex-col bg-white">
        <div class="bg-green-600 text-white p-4 shadow-md sticky top-0 z-20">
            <div class="max-w-3xl mx-auto flex items-center justify-between">
                <button id="btn-back-add" class="bg-white text-green-700 px-6 py-2 rounded-lg font-bold border-2 border-green-200">&lt; 返回首页</button>
                <h1 id="title-add" class="text-xl font-bold outline-none" tabindex="-1">新增物品</h1>
            </div>
        </div>
        
        <div class="max-w-lg mx-auto w-full p-6 overflow-y-auto">
            <form id="form-add" class="space-y-6">
                <div>
                    <label for="add-name" class="block font-bold mb-2 text-xl">物品名称 (必填)</label>
                    <input type="text" id="add-name" required class="w-full p-4 border-2 border-gray-300 rounded-lg text-xl" placeholder="如：牛奶" aria-label="物品名称">
                </div>
                <div>
                    <label for="add-unit" class="block font-bold mb-2 text-xl">单位 (支持上下光标选择)</label>
                    <input type="text" id="add-unit" list="unit-presets" class="w-full p-4 border-2 border-gray-300 rounded-lg text-xl" placeholder="选择或输入" value="个" aria-label="单位">
                </div>
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label for="add-room" class="block font-bold mb-2 text-xl">房间</label>
                        <select id="add-room" class="w-full p-4 border-2 border-gray-300 rounded-lg text-xl bg-white text-black" aria-label="选择房间">
                            <option value="厨房">厨房</option>
                            <option value="客厅">客厅</option>
                            <option value="卧室">卧室</option>
                            <option value="书房">书房</option>
                            <option value="餐厅">餐厅</option>
                            <option value="玄关">玄关</option>
                            <option value="卫生间">卫生间</option>
                            <option value="洗衣房">洗衣房</option>
                        </select>
                    </div>
                    <div>
                        <label for="add-location" class="block font-bold mb-2 text-xl">具体位置</label>
                        <input type="text" id="add-location" class="w-full p-4 border-2 border-gray-300 rounded-lg text-xl" placeholder="如：柜子第二层" aria-label="具体位置">
                    </div>
                </div>
                <div>
                    <label class="block font-bold mb-2 text-xl">初始数量</label>
                    <button type="button" id="btn-add-qty-trigger" class="w-full p-4 border-2 border-blue-300 bg-blue-50 text-blue-900 font-bold text-left text-xl rounded-lg" aria-label="设置初始数量">
                        当前选择：1 (点击修改)
                    </button>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white p-5 rounded-lg font-bold text-2xl mt-8 shadow-lg">保存并继续</button>
            </form>
        </div>
    </div>

    <div id="screen-edit" class="screen hidden min-h-screen flex flex-col bg-white">
        <div class="bg-indigo-600 text-white p-4 shadow-md sticky top-0 z-20">
            <div class="max-w-3xl mx-auto flex items-center justify-between">
                <button id="btn-back-edit" class="bg-white text-indigo-700 px-6 py-2 rounded-lg font-bold border-2 border-indigo-200">&lt; 返回列表</button>
                <h1 id="title-edit" class="text-xl font-bold outline-none" tabindex="-1">编辑物品</h1>
            </div>
        </div>
        
        <div class="max-w-lg mx-auto w-full p-6 overflow-y-auto">
            <form id="form-edit" class="space-y-6">
                <div>
                    <label for="edit-name" class="block font-bold mb-2 text-xl">物品名称</label>
                    <input type="text" id="edit-name" required class="w-full p-4 border-2 border-gray-300 rounded-lg text-xl" aria-label="物品名称">
                </div>
                <div>
                    <label for="edit-unit" class="block font-bold mb-2 text-xl">单位</label>
                    <input type="text" id="edit-unit" list="unit-presets" class="w-full p-4 border-2 border-gray-300 rounded-lg text-xl" aria-label="单位">
                </div>
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label for="edit-room" class="block font-bold mb-2 text-xl">房间</label>
                        <select id="edit-room" class="w-full p-4 border-2 border-gray-300 rounded-lg text-xl bg-white text-black" aria-label="房间">
                            <option value="厨房">厨房</option>
                            <option value="客厅">客厅</option>
                            <option value="卧室">卧室</option>
                            <option value="书房">书房</option>
                            <option value="餐厅">餐厅</option>
                            <option value="玄关">玄关</option>
                            <option value="卫生间">卫生间</option>
                            <option value="洗衣房">洗衣房</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-location" class="block font-bold mb-2 text-xl">具体位置</label>
                        <input type="text" id="edit-location" class="w-full p-4 border-2 border-gray-300 rounded-lg text-xl" aria-label="具体位置">
                    </div>
                </div>
                <div>
                    <label for="edit-quantity" class="block font-bold mb-2 text-xl">数量 (直接修改)</label>
                    <input type="number" id="edit-quantity" class="w-full p-4 border-2 border-blue-300 bg-blue-50 text-blue-900 font-bold text-xl rounded-lg" aria-label="数量">
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-5 rounded-lg font-bold text-2xl mt-8 shadow-lg">保存修改</button>
            </form>
        </div>
    </div>

    <div id="screen-data" class="screen hidden min-h-screen flex flex-col bg-white">
        <div class="bg-blue-700 text-white p-4 shadow-md sticky top-0 z-20">
            <div class="max-w-3xl mx-auto flex items-center justify-between">
                <button id="btn-back-data" class="bg-white text-blue-700 px-6 py-2 rounded-lg font-bold border-2 border-blue-200">&lt; 返回首页</button>
                <h1 id="title-data" class="text-xl font-bold outline-none" tabindex="-1">数据管理</h1>
            </div>
        </div>
        <div class="max-w-lg mx-auto w-full p-8 flex flex-col gap-6 mt-10">
            <button id="btn-export" class="w-full p-6 bg-green-50 border-2 border-green-500 text-green-900 font-bold rounded-xl text-xl hover:bg-green-100 shadow-sm text-left">导出备份数据 (CSV)</button>
            <hr class="border-gray-200 my-2">
            <p class="text-lg font-bold text-gray-700">批量导入：</p>
            <button id="btn-download-template" class="w-full p-6 bg-gray-50 border-2 border-gray-400 text-gray-800 font-bold rounded-xl text-xl hover:bg-gray-100 shadow-sm text-left">下载导入模板</button>
            <button id="btn-trigger-upload" class="w-full p-6 bg-blue-50 border-2 border-blue-500 text-blue-900 font-bold rounded-xl text-xl hover:bg-blue-100 shadow-sm text-left">上传填写好的文件</button>
            <input type="file" id="file-upload" accept=".csv" class="hidden">
        </div>
    </div>

    <div id="modal-forgot" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl text-center border-4 border-gray-300">
            <h2 id="title-forgot" class="text-2xl font-bold mb-4 outline-none" tabindex="-1">找回密码</h2>
            <p class="mb-4 text-gray-600">请输入注册邮箱，系统将发送重置邮件。</p>
            <label for="forgot-email" class="sr-only">邮箱地址</label>
            <input type="email" id="forgot-email" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-6 text-lg" placeholder="邮箱地址" aria-label="找回密码邮箱">
            <div class="flex gap-3">
                <button id="btn-cancel-forgot" class="flex-1 p-3 bg-gray-200 font-bold rounded-lg text-lg">取消</button>
                <button id="btn-send-reset" class="flex-1 p-3 bg-blue-600 text-white font-bold rounded-lg text-lg">发送邮件</button>
            </div>
        </div>
    </div>

    <div id="modal-action" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl text-center border-4 border-gray-300">
            <h2 id="action-title" class="text-2xl font-bold mb-2 text-gray-900 outline-none" tabindex="-1">管理物品</h2>
            <p id="action-desc" class="text-lg text-gray-600 mb-6">详情</p>
            <div class="flex flex-col gap-4" id="action-buttons-container">
                <button id="btn-act-put" class="p-4 bg-blue-100 text-blue-900 font-bold rounded-xl border-2 border-blue-300 text-xl" data-action="put">放入 (增加)</button>
                <button id="btn-act-take" class="p-4 bg-orange-100 text-orange-900 font-bold rounded-xl border-2 border-orange-300 text-xl" data-action="take">取出 (减少)</button>
                <button id="btn-act-edit" class="p-4 bg-indigo-100 text-indigo-900 font-bold rounded-xl border-2 border-indigo-300 text-xl" data-action="edit">修改详情</button>
                <button id="btn-act-del" class="p-4 bg-red-100 text-red-900 font-bold rounded-xl border-2 border-red-300 text-xl" data-action="delete">删除物品</button>
                <button class="p-4 bg-gray-100 text-gray-800 font-bold rounded-xl border-2 border-gray-300 text-xl mt-2" onclick="closeModals()">取消</button>
            </div>
        </div>
    </div>

    <div id="modal-qty" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex justify-center items-end sm:items-center">
        <div class="bg-white w-full max-w-md p-6 rounded-t-2xl sm:rounded-2xl shadow-2xl border-t-4 border-blue-500">
            <h2 id="qty-title" class="text-2xl font-bold mb-6 text-center text-gray-900 outline-none" tabindex="-1">选择数量</h2>
            <div class="grid grid-cols-5 gap-3 mb-6" id="qty-grid"></div>
            <div class="flex gap-2 mb-6 items-stretch">
                <div id="qty-custom-trigger" class="custom-input-trigger" role="button" tabindex="0" aria-label="自定义数量，按回车输入">
                    <span class="mr-2 font-bold text-gray-700 text-lg">自定义:</span>
                    <label for="qty-custom-input" class="sr-only">输入数量</label>
                    <input type="number" id="qty-custom-input" class="w-24 p-2 border-b-4 border-gray-400 text-center font-bold text-xl bg-gray-50 text-black" disabled placeholder="#" tabindex="-1" aria-label="输入自定义数量">
                </div>
                <button id="btn-qty-confirm" class="bg-blue-600 text-white font-bold px-6 rounded-lg shadow-lg disabled:opacity-50 text-lg" disabled tabindex="-1">确定</button>
            </div>
            <button class="w-full p-4 bg-gray-200 text-gray-800 rounded-xl font-bold text-xl" onclick="closeModals()">取消</button>
        </div>
    </div>

    <div id="modal-zero" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl text-center border-4 border-orange-400">
            <h2 id="title-zero" class="text-2xl font-bold mb-4 text-orange-700 outline-none" tabindex="-1">数量已空</h2>
            <p class="mb-6 text-gray-800 text-lg">物品数量已归零，请选择操作：</p>
            <div class="flex flex-col gap-4">
                <button id="btn-zero-keep" class="p-4 bg-blue-100 text-blue-900 rounded-xl font-bold border-2 border-blue-200 text-lg">保留物品 (数量设为0)</button>
                <button id="btn-zero-del" class="p-4 bg-red-100 text-red-900 rounded-xl font-bold border-2 border-red-200 text-lg">删除物品</button>
                <button id="btn-zero-cancel" class="p-4 bg-gray-200 text-gray-900 rounded-xl font-bold border-2 border-gray-300 text-lg">取消操作 (撤销)</button>
            </div>
        </div>
    </div>

    <div id="modal-confirm" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl text-center border-4 border-red-400">
            <h2 id="title-confirm" class="text-2xl font-bold mb-4 text-red-700 outline-none" tabindex="-1">操作确认</h2>
            <p id="confirm-text" class="mb-6 text-gray-800 text-lg"></p>
            <div class="flex gap-4">
                <button id="btn-confirm-cancel" class="flex-1 p-4 bg-gray-200 rounded-xl font-bold text-lg" onclick="closeModals()">取消</button>
                <button id="btn-confirm-ok" class="flex-1 p-4 bg-red-600 text-white rounded-xl font-bold text-lg shadow">确认执行</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged, deleteUser, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, where, doc, updateDoc, deleteDoc, writeBatch, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Config
        const firebaseConfig = {
            apiKey: "AIzaSyC3rxfvajIswJADfzJD0lphVra99vka7nE",
            authDomain: "household-item-management.firebaseapp.com",
            projectId: "household-item-management",
            storageBucket: "household-item-management.firebasestorage.app",
            messagingSenderId: "1042289941268",
            appId: "1:1042289941268:web:2d77a3a9fb2cf666ed0001"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const itemsRef = collection(db, "items");

        // State
        let allItems = [];
        let currentActionItem = null;
        let pendingAddQty = 1;
        let homeFilterRoom = 'all';
        let unsubscribeItems = null;
        let focusTargetId = null; 
        let qtyCallback = null;
        let confirmCallback = null;
        let previousScreenTarget = 'screen-home'; // 简化：用于编辑后的返回

        // Unit Presets
        let UNIT_LIST = ["个", "包", "箱", "瓶", "袋", "条", "块", "只", "支", "把", "张", "双", "套", "组", "对", "本", "册", "罐", "桶", "壶", "杯", "斤", "公斤", "升", "毫升"];
        const savedUnits = JSON.parse(localStorage.getItem('custom_units') || '[]');
        UNIT_LIST = [...new Set([...UNIT_LIST, ...savedUnits])];

        function populateUnitDatalist() {
            const dl = document.getElementById('unit-presets');
            dl.innerHTML = '';
            UNIT_LIST.forEach(u => {
                const op = document.createElement('option');
                op.value = u;
                dl.appendChild(op);
            });
        }
        populateUnitDatalist();

        function learnNewUnit(unit) {
            if(!unit) return;
            if(!UNIT_LIST.includes(unit)) {
                UNIT_LIST.push(unit);
                localStorage.setItem('custom_units', JSON.stringify(UNIT_LIST));
                populateUnitDatalist();
            }
        }

        // Fix 3: 单位选择光标问题 - 确保自定义光标切换逻辑能正常工作
        function attachUnitKeyHandler(inputId) {
            const el = document.getElementById(inputId);
            el.addEventListener('keydown', (e) => {
                // 仅处理上下光标
                if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                    e.preventDefault(); // 阻止浏览器默认行为（打开datalist）
                    e.stopPropagation(); // 阻止事件冒泡
                    
                    let idx = UNIT_LIST.indexOf(el.value);
                    
                    // 如果当前值不在列表中，ArrowDown 从头开始，ArrowUp 从尾部开始
                    if (idx === -1) idx = e.key === 'ArrowDown' ? -1 : 0; 
                    
                    if (e.key === 'ArrowDown') idx = (idx + 1) % UNIT_LIST.length;
                    else idx = (idx - 1 + UNIT_LIST.length) % UNIT_LIST.length;
                    
                    el.value = UNIT_LIST[idx];
                    
                    // 修复：确保光标停留在输入框末尾
                    el.selectionStart = el.selectionEnd = el.value.length;
                    
                    announce(`单位切换到 ${el.value}`);
                }
            });
        }
        attachUnitKeyHandler('add-unit');
        attachUnitKeyHandler('edit-unit');

        const savedEmail = localStorage.getItem('savedEmail');
        if(savedEmail) document.getElementById('login-email').value = savedEmail;

        // Fix 2: 恢复 announce 播报函数
        window.announce = (msg) => {
            const el = document.getElementById('live-announcer');
            el.textContent = msg;
            setTimeout(() => el.textContent = '', 1000);
        };

        // --- Screen Switcher ---
        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(screenId);
            target.classList.remove('hidden');
            
            if (screenId === 'screen-edit') {
                 // 在进入编辑页面时记录从哪里来
                 const visibleScreen = Array.from(document.querySelectorAll('.screen')).find(el => !el.classList.contains('hidden'));
                 if(visibleScreen && visibleScreen.id !== 'screen-login' && visibleScreen.id !== 'screen-register') {
                    previousScreenTarget = visibleScreen.id;
                 }
            }
            
            // Priority Focus
            if (!focusTargetId) {
                setTimeout(() => {
                    const h1 = target.querySelector('h1');
                    if (h1) h1.focus();
                }, 100);
            }

            if(screenId === 'screen-home') refreshHomeList();
            // 在切换到结果页时，确保执行搜索并渲染
            if (screenId === 'screen-results') performSearch(document.getElementById('title-results').dataset.term);
        }

        // 通用模态框关闭
        window.closeModals = () => {
            document.querySelectorAll('[id^="modal-"]').forEach(m => m.classList.add('hidden'));
            
            // 焦点恢复逻辑
            const currentVisibleScreen = Array.from(document.querySelectorAll('.screen')).find(el => !el.classList.contains('hidden'));
            if (!currentVisibleScreen) return;
            const currentScreenId = currentVisibleScreen.id;

            let containerId;
            if (currentScreenId === 'screen-results') containerId = 'results-list';
            else if (currentScreenId === 'screen-home') containerId = 'home-list';
            else return; 
            
            const container = document.getElementById(containerId);
            
            if (currentActionItem && currentActionItem.id) {
                const target = container.querySelector(`.item-card[data-id="${currentActionItem.id}"]`);
                if (target) {
                    target.focus();
                    return;
                }
            }
            const first = container.querySelector('.item-card');
            if (first) first.focus();
        };

        // --- Auth ---
        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('btn-account-menu').setAttribute('aria-label', `当前账号：${user.email}，点击展开菜单`);
                document.getElementById('user-email-display').textContent = user.email.split('@')[0];
                switchScreen('screen-home');
                setupDataListener(user.uid);
            } else {
                if(unsubscribeItems) unsubscribeItems();
                allItems = [];
                switchScreen('screen-login');
            }
        });

        document.getElementById('login-password').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('btn-login').click();
            }
        });

        document.getElementById('btn-login').addEventListener('click', async () => {
            const e = document.getElementById('login-email').value;
            const p = document.getElementById('login-password').value;
            const autoLogin = document.getElementById('chk-auto-login').checked;
            const rememberEmail = document.getElementById('chk-remember-email').checked;

            if(rememberEmail) localStorage.setItem('savedEmail', e);
            else localStorage.removeItem('savedEmail');

            try {
                await setPersistence(auth, autoLogin ? browserLocalPersistence : browserSessionPersistence);
                await signInWithEmailAndPassword(auth, e, p);
            } catch(err) {
                announce("登录失败"); alert("登录失败：" + err.message);
            }
        });

        // Account Menu
        const btnAccount = document.getElementById('btn-account-menu');
        const menuAccount = document.getElementById('menu-account-dropdown');
        btnAccount.addEventListener('click', (e) => {
            e.stopPropagation();
            menuAccount.classList.toggle('hidden');
            btnAccount.setAttribute('aria-expanded', menuAccount.classList.contains('hidden') ? 'false' : 'true');
            if(!menuAccount.classList.contains('hidden')) menuAccount.querySelector('button').focus();
        });
        document.addEventListener('click', (e) => {
            if (!btnAccount.contains(e.target) && !menuAccount.contains(e.target)) {
                menuAccount.classList.add('hidden');
                btnAccount.setAttribute('aria-expanded', 'false');
            }
        });

        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth).then(() => announce("已退出")));
        document.getElementById('btn-clear-data').addEventListener('click', () => {
            menuAccount.classList.add('hidden');
            openGenericConfirm("确定清空数据？", async () => {
                const batch = writeBatch(db);
                const q = query(itemsRef, where("uid", "==", auth.currentUser.uid));
                const snapshot = await getDocs(q);
                snapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                announce("已清空"); // Fix 2: 恢复播报
            });
        });
        document.getElementById('btn-delete-account').addEventListener('click', () => {
            menuAccount.classList.add('hidden');
            openGenericConfirm("确定删除账号？", async () => {
                const batch = writeBatch(db);
                const q = query(itemsRef, where("uid", "==", auth.currentUser.uid));
                const snapshot = await getDocs(q);
                snapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                await deleteUser(auth.currentUser);
                announce("已注销账号"); // Fix 2: 恢复播报
            });
        });

        document.getElementById('btn-to-register').addEventListener('click', () => switchScreen('screen-register'));
        document.getElementById('btn-back-login').addEventListener('click', () => switchScreen('screen-login'));
        document.getElementById('btn-submit-reg').addEventListener('click', () => {
            const e = document.getElementById('reg-email').value;
            const p1 = document.getElementById('reg-pass').value;
            const p2 = document.getElementById('reg-pass-confirm').value;
            if (p1 !== p2 || p1.length < 6) { alert("密码问题"); return; }
            createUserWithEmailAndPassword(auth, e, p1).then(() => {
                announce("注册成功"); // Fix 2: 恢复播报
            }).catch(err => alert(err.message));
        });

        document.getElementById('btn-forgot-pass').addEventListener('click', () => {
            document.getElementById('modal-forgot').classList.remove('hidden');
            setTimeout(() => document.getElementById('title-forgot').focus(), 100);
        });
        document.getElementById('btn-cancel-forgot').addEventListener('click', () => document.getElementById('modal-forgot').classList.add('hidden'));
        document.getElementById('btn-send-reset').addEventListener('click', () => {
            const e = document.getElementById('forgot-email').value;
            if(!e) return;
            sendPasswordResetEmail(auth, e).then(() => {
                alert("已发送"); announce("重置邮件已发送"); // Fix 2: 恢复播报
                document.getElementById('modal-forgot').classList.add('hidden');
            }).catch(err => alert(err.message));
        });

        // --- Data Logic (Micro-update) ---
        function setupDataListener(uid) {
            if(unsubscribeItems) unsubscribeItems();
            const q = query(itemsRef, where("uid", "==", uid));
            unsubscribeItems = onSnapshot(q, snap => {
                let isFirstLoad = allItems.length === 0;
                snap.docChanges().forEach(change => {
                    const data = { id: change.doc.id, ...change.doc.data() };
                    // 使用 Array.prototype.findIndex 查找索引
                    const idx = allItems.findIndex(i => i.id === data.id);

                    if (change.type === "added") {
                        // 首次加载按时间戳排序，后续新增则直接放在最前面
                        if (isFirstLoad) allItems.push(data);
                        else allItems.unshift(data); 
                    }
                    if (change.type === "modified") {
                        if (idx > -1) allItems[idx] = data;
                    }
                    if (change.type === "removed") {
                        allItems = allItems.filter(i => i.id !== data.id);
                    }
                });
                if (isFirstLoad) {
                    allItems.sort((a, b) => (b.updatedAt?.toMillis() || 0) - (a.updatedAt?.toMillis() || 0));
                }
                
                // 优化：检查当前可见屏幕，只在当前屏幕更新列表
                const currentScreen = Array.from(document.querySelectorAll('.screen')).find(el => !el.classList.contains('hidden'));
                
                if (currentScreen && currentScreen.id === 'screen-home') {
                    refreshHomeList();
                } else if (currentScreen && currentScreen.id === 'screen-results') {
                    // 当搜索页面可见时，重新执行搜索/过滤
                    const term = document.getElementById('title-results').dataset.term;
                    if (term) performSearch(term);
                }
            });
        }

        function refreshHomeList() {
            renderList('home-list', homeFilterRoom, allItems);
        }

        // --- The Micro-Update Renderer ---
        function renderList(containerId, filterRoom, sourceArray) {
            const container = document.getElementById(containerId);
            
            const filtered = sourceArray.filter(item => {
                return filterRoom === 'all' || item.room === filterRoom;
            });

            if (filtered.length === 0) {
                container.innerHTML = `<div class="text-center p-6 text-gray-500 text-lg">无相关物品</div>`;
                return;
            }

            // Map existing DOM elements
            const existingMap = new Map();
            container.querySelectorAll('.item-card').forEach(el => existingMap.set(el.dataset.id, el));

            // 1. Remove deleted items
            existingMap.forEach((el, id) => {
                if (!filtered.find(i => i.id === id)) el.remove();
            });

            // 2. Update or Create items
            filtered.forEach(item => {
                let card = existingMap.get(item.id);
                const labelText = `${item.name}，${item.room} ${item.location||''}，${item.quantity}${item.unit||'个'}`;
                const htmlContent = `
                    <div class="flex justify-between items-center pointer-events-none">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 item-name">${item.name}</h3>
                            <p class="text-base text-gray-600 font-bold item-loc">${item.room} - ${item.location || '位置未填'}</p>
                        </div>
                        <div class="text-3xl font-bold text-blue-700 item-qty">${item.quantity} <span class="text-lg text-gray-500">${item.unit||'个'}</span></div>
                    </div>
                `;

                if (card) {
                    // Micro-update: Check if content changed
                    if (card.getAttribute('aria-label') !== (labelText + "。按回车管理。")) {
                        card.innerHTML = htmlContent;
                        card.setAttribute('aria-label', labelText + "。按回车管理。");
                    }
                } else {
                    card = document.createElement('div');
                    card.className = "item-card bg-white p-4 rounded-lg shadow border-l-8 border-blue-500 cursor-pointer relative mb-3";
                    card.setAttribute('role', 'button');
                    card.setAttribute('tabindex', '0');
                    card.dataset.id = item.id;
                    card.setAttribute('aria-label', labelText + "。按回车管理。");
                    card.innerHTML = htmlContent;
                    
                    const triggerMenu = () => openActionMenu(item);
                    card.addEventListener('click', triggerMenu);
                    card.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault(); triggerMenu();
                        }
                    });
                    container.appendChild(card);
                }
            });

            // Focus Restoration
            if (focusTargetId) {
                const target = container.querySelector(`[data-id="${focusTargetId}"]`);
                if (target) {
                    target.focus();
                    focusTargetId = null;
                }
            }
        }

        function updateStats(items) {
            const statsContainer = document.getElementById('results-stats');
            if (items.length > 0) {
                const totals = {};
                items.forEach(item => {
                    const u = item.unit || '个';
                    totals[u] = (totals[u] || 0) + item.quantity;
                });
                const summaryText = Object.entries(totals).map(([u, q]) => `${q} ${u}`).join('、');
                statsContainer.textContent = `共找到 ${items.length} 处。合计：${summaryText}`;
            } else {
                 statsContainer.textContent = `无相关物品`;
            }
        }

        // --- Home Screen Logic ---
        document.getElementById('home-filter').addEventListener('change', (e) => {
            homeFilterRoom = e.target.value;
            refreshHomeList();
        });

        // Search Trigger
        const homeSearchInput = document.getElementById('home-search');
        const btnDoSearch = document.getElementById('btn-do-search');
        let currentSearchResults = [];
        
        // 新增功能 4: 清除按钮逻辑
        const btnClearSearch = document.getElementById('btn-clear-search');

        function updateClearButtonVisibility() {
            if (homeSearchInput.value.length > 0) {
                btnClearSearch.classList.remove('hidden');
            } else {
                btnClearSearch.classList.add('hidden');
            }
        }

        homeSearchInput.addEventListener('input', updateClearButtonVisibility); // 监听输入，实时更新按钮状态
        
        btnClearSearch.addEventListener('click', () => {
            homeSearchInput.value = ''; // 清空输入框
            updateClearButtonVisibility(); // 隐藏按钮
            homeSearchInput.focus(); // 焦点返回输入框
            announce("搜索输入已清空"); // Fix 2: 恢复播报
        });


        function performSearch(term) {
            const t = term ? term.trim().toLowerCase() : homeSearchInput.value.trim().toLowerCase();
            if (!t) {
                currentSearchResults = allItems;
            } else {
                document.getElementById('title-results').textContent = `搜索：${t}`;
                document.getElementById('title-results').dataset.term = t; 
                
                currentSearchResults = allItems.filter(item => {
                    return item.name.toLowerCase().includes(t) || (item.location||'').toLowerCase().includes(t);
                });
            }
            
            // 确保在结果页
            if (document.getElementById('screen-results').classList.contains('hidden')) {
                 switchScreen('screen-results');
            }
            
            renderList('results-list', 'all', currentSearchResults);
            updateStats(currentSearchResults);
            
            announce(`搜索完成，找到 ${currentSearchResults.length} 个结果`); // Fix 2: 恢复播报
        }

        btnDoSearch.addEventListener('click', () => performSearch());
        homeSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        // Results Page Logic
        document.getElementById('btn-back-results').addEventListener('click', () => {
            switchScreen('screen-home');
            homeSearchInput.value = ''; // 清空搜索框
            updateClearButtonVisibility();
        });


        // --- Navigation ---
        document.getElementById('btn-nav-takeout').addEventListener('click', () => {
            document.getElementById('home-search').focus();
            announce("请输入名称搜索要取出的物品"); // Fix 2: 恢复播报
        });

        document.getElementById('btn-nav-add').addEventListener('click', () => {
            switchScreen('screen-add');
            document.getElementById('add-name').focus();
            pendingAddQty = 1;
            updateAddQtyDisplay();
        });
        document.getElementById('btn-back-add').addEventListener('click', () => switchScreen('screen-home'));
        document.getElementById('btn-nav-data').addEventListener('click', () => switchScreen('screen-data'));
        document.getElementById('btn-back-data').addEventListener('click', () => switchScreen('screen-home'));

        document.getElementById('btn-back-edit').addEventListener('click', () => switchScreen(previousScreenTarget)); // 使用记录的目标

        // Fix 1: 修复编辑页面无法自动关闭的问题
        document.getElementById('form-edit').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newQty = parseInt(document.getElementById('edit-quantity').value);
            const unitVal = document.getElementById('edit-unit').value;
            learnNewUnit(unitVal);
            if (newQty === 0) { openZeroConfirmEdit(newQty); return; }
            await executeEdit(newQty);
        });

        // Fix 1 & 2: 修复编辑页保存后不关闭和播报缺失的问题
        async function executeEdit(newQty) {
            focusTargetId = currentActionItem.id;
            try {
                await updateDoc(doc(db, "items", currentActionItem.id), {
                    name: document.getElementById('edit-name').value,
                    room: document.getElementById('edit-room').value,
                    location: document.getElementById('edit-location').value,
                    unit: document.getElementById('edit-unit').value,
                    quantity: newQty,
                    updatedAt: serverTimestamp()
                });
                announce("修改成功"); // Fix 2: 恢复播报
                switchScreen(previousScreenTarget); // Fix 1: 确保页面自动关闭
            } catch(e) { announce("修改失败"); } // Fix 2: 恢复播报
        }

        function openZeroConfirmEdit(newQty) {
            const m = document.getElementById('modal-zero');
            m.classList.remove('hidden');
            closeModals(); // 确保其他模态框关闭
            setTimeout(() => document.getElementById('title-zero').focus(), 100);
            document.getElementById('btn-zero-keep').onclick = async () => {
                m.classList.add('hidden');
                await executeEdit(0);
            };
            document.getElementById('btn-zero-del').onclick = async () => {
                m.classList.add('hidden');
                await execDelete();
                switchScreen(previousScreenTarget);
            };
            document.getElementById('btn-zero-cancel').onclick = () => {
                m.classList.add('hidden');
                announce("已取消操作"); // Fix 2: 恢复播报
            };
        }

        // Menu
        function openActionMenu(item) {
            currentActionItem = item;
            const modal = document.getElementById('modal-action');
            document.getElementById('action-title').textContent = `管理：${item.name}`;
            document.getElementById('action-desc').textContent = `剩余：${item.quantity} ${item.unit||'个'}`;
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                const v = modal.querySelectorAll('button:not(.hidden)');
                if(v.length > 0) v[0].focus();
            }, 100);
        }

        document.getElementById('action-buttons-container').addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const act = btn.dataset.action;
            if (act === 'put') openQtyPicker("放入数量", (n) => handleUpdate(n));
            if (act === 'take') openQtyPicker("取出数量", (n) => handleUpdate(-n));
            if (act === 'delete') openGenericConfirm(`确定删除 ${currentActionItem.name} 吗？`, execDelete);
            if (act === 'edit') openEditScreen(currentActionItem);
        });

        function openEditScreen(item) {
            document.getElementById('modal-action').classList.add('hidden');
            switchScreen('screen-edit');
            document.getElementById('edit-name').value = item.name;
            document.getElementById('edit-room').value = item.room;
            document.getElementById('edit-location').value = item.location;
            document.getElementById('edit-unit').value = item.unit || '个';
            document.getElementById('edit-quantity').value = item.quantity;
        }

        const qtyGrid = document.getElementById('qty-grid');
        qtyGrid.innerHTML = '';
        for(let i=1; i<=10; i++) {
            const btn = document.createElement('button');
            btn.className = 'qty-btn';
            btn.textContent = i;
            const handler = (e) => {
                if(e.type === 'keydown' && e.key !== 'Enter') return;
                e.preventDefault(); e.stopPropagation();
                submitQty(i);
            };
            btn.addEventListener('click', handler);
            btn.addEventListener('keydown', handler);
            qtyGrid.appendChild(btn);
        }

        function openQtyPicker(title, cb) {
            qtyCallback = cb;
            document.getElementById('qty-title').textContent = title;
            document.getElementById('modal-action').classList.add('hidden');
            document.getElementById('modal-qty').classList.remove('hidden');
            const input = document.getElementById('qty-custom-input');
            const confirm = document.getElementById('btn-qty-confirm');
            const trigger = document.getElementById('qty-custom-trigger');
            input.value = ''; input.disabled = true;
            confirm.disabled = true; confirm.classList.add('opacity-50');
            confirm.setAttribute('tabindex', '-1'); trigger.setAttribute('tabindex', '0');
            setTimeout(() => { qtyGrid.firstChild.focus(); announce("请选择数量"); }, 100);
        }

        const customTrigger = document.getElementById('qty-custom-trigger');
        function activateInput() {
            const input = document.getElementById('qty-custom-input');
            const confirm = document.getElementById('btn-qty-confirm');
            const trigger = document.getElementById('qty-custom-trigger');
            trigger.setAttribute('tabindex', '-1');
            input.disabled = false; input.focus();
            confirm.disabled = false; confirm.classList.remove('opacity-50');
            confirm.setAttribute('tabindex', '0');
            announce("请输入数字"); // Fix 2: 恢复播报
        }
        customTrigger.addEventListener('click', activateInput);
        customTrigger.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault(); e.stopPropagation();
                activateInput();
            }
        });
        document.getElementById('qty-custom-input').addEventListener('keydown', (e) => {
            if(e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault(); e.stopPropagation();
                submitQty(parseInt(e.target.value));
            }
        });
        document.getElementById('btn-qty-confirm').addEventListener('click', () => {
            submitQty(parseInt(document.getElementById('qty-custom-input').value));
        });

        function submitQty(val) {
            if (!val || val <= 0) { announce("无效数量"); return; } // Fix 2: 恢复播报
            if (qtyCallback) qtyCallback(val);
            document.getElementById('modal-qty').classList.add('hidden');
        }

        async function handleUpdate(change) {
            if (!currentActionItem) return;
            const newQty = currentActionItem.quantity + change;
            if (newQty === 0) { openZeroConfirm(); return; }
            if (newQty < 0) { announce("库存不足"); return; } // Fix 2: 恢复播报
            await execUpdate(change);
        }

        // Fix 2: 恢复播报
        async function execUpdate(change) {
            focusTargetId = currentActionItem.id;
            try {
                await updateDoc(doc(db, "items", currentActionItem.id), {
                    quantity: increment(change),
                    updatedAt: serverTimestamp()
                });
                announce("更新成功"); // Fix 2: 恢复播报
                closeModals();
            } catch(e) { announce("更新失败"); } // Fix 2: 恢复播报
        }

        function openZeroConfirm() {
            const m = document.getElementById('modal-zero');
            m.classList.remove('hidden');
            closeModals(); // 确保其他模态框关闭
            setTimeout(() => document.getElementById('title-zero').focus(), 100);
            
            document.getElementById('btn-zero-keep').onclick = async () => {
                m.classList.add('hidden');
                await execUpdate(-currentActionItem.quantity);
            };
            document.getElementById('btn-zero-del').onclick = async () => {
                m.classList.add('hidden');
                await execDelete();
            };
            document.getElementById('btn-zero-cancel').onclick = () => {
                m.classList.add('hidden');
                announce("已取消操作"); // Fix 2: 恢复播报
                closeModals();
            };
        }

        function openGenericConfirm(msg, cb) {
            document.getElementById('modal-action').classList.add('hidden');
            const m = document.getElementById('modal-confirm');
            m.classList.remove('hidden');
            document.getElementById('confirm-text').textContent = msg;
            confirmCallback = cb;
            setTimeout(() => document.getElementById('title-confirm').focus(), 100);
        }
        document.getElementById('btn-confirm-ok').addEventListener('click', () => {
            if(confirmCallback) confirmCallback();
            document.getElementById('modal-confirm').classList.add('hidden');
        });

        // Fix 2: 恢复播报
        async function execDelete() {
            try {
                await deleteDoc(doc(db, "items", currentActionItem.id));
                announce("已删除"); // Fix 2: 恢复播报
                closeModals();
            } catch(e) { announce("删除失败"); } // Fix 2: 恢复播报
        }

        // Add Item
        document.getElementById('btn-add-qty-trigger').addEventListener('click', () => {
            openQtyPicker("设置数量", (v) => {
                pendingAddQty = v;
                updateAddQtyDisplay();
                document.getElementById('modal-qty').classList.add('hidden');
                // 焦点回传
                document.getElementById('btn-add-qty-trigger').focus();
            });
        });
        function updateAddQtyDisplay() {
            document.getElementById('btn-add-qty-trigger').textContent = `数量：${pendingAddQty} (点击修改)`;
        }
        document.getElementById('add-name').addEventListener('change', (e) => {
            const name = e.target.value.trim();
            if(name) {
                const match = allItems.find(i => i.name === name);
                if(match && match.unit) {
                    document.getElementById('add-unit').value = match.unit;
                    announce("自动填入单位：" + match.unit); // Fix 2: 恢复播报
                }
            }
        });
        document.getElementById('form-add').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('add-name');
            const unitVal = document.getElementById('add-unit').value || '个';
            learnNewUnit(unitVal);
            try {
                const newDocRef = await addDoc(itemsRef, {
                    name: nameInput.value,
                    room: document.getElementById('add-room').value,
                    location: document.getElementById('add-location').value,
                    unit: unitVal,
                    quantity: pendingAddQty,
                    uid: auth.currentUser.uid,
                    updatedAt: serverTimestamp()
                });
                announce(`已添加 ${nameInput.value}`); // Fix 2: 恢复播报
                
                // 重置表单，以便继续添加
                nameInput.value = '';
                document.getElementById('add-location').value = '';
                pendingAddQty = 1;
                updateAddQtyDisplay();
                nameInput.focus();
            } catch(e) { announce("添加失败"); } // Fix 2: 恢复播报
        });

        // Export/Import
        document.getElementById('btn-export').addEventListener('click', () => {
            let csvContent = "\uFEFF物品名称,房间,具体位置,数量,单位\n";
            allItems.forEach(item => {
                csvContent += `${item.name},${item.room},${item.location || ''},${item.quantity},${item.unit||'个'}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `物品备份_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            announce("导出成功"); // Fix 2: 恢复播报
        });
        document.getElementById('btn-download-template').addEventListener('click', () => {
            const csvContent = "\uFEFF物品名称(必填),房间(必填),具体位置,数量(数字),单位\n大米,厨房,柜子,1,袋\n牛奶,客厅,桌子,2,箱";
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `导入模板.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            announce("模板下载成功"); // Fix 2: 恢复播报
        });
        document.getElementById('btn-trigger-upload').addEventListener('click', () => document.getElementById('file-upload').click());
        document.getElementById('file-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const rows = text.split('\n');
                let count = 0;
                // 从第 1 行开始（跳过标题行）
                for (let i = 1; i < rows.length; i++) { 
                    const row = rows[i].trim();
                    if (!row) continue;
                    // 简单的 CSV 解析：按逗号分割
                    const cols = row.split(',');
                    if (cols.length < 1) continue;
                    const name = cols[0]?.trim();
                    if(!name) continue;
                    await addDoc(itemsRef, {
                        name: name,
                        room: cols[1]?.trim() || '客厅',
                        location: cols[2]?.trim() || '',
                        quantity: parseInt(cols[3]) || 1,
                        unit: cols[4]?.trim() || '个',
                        uid: auth.currentUser.uid,
                        updatedAt: serverTimestamp()
                    });
                    count++;
                }
                announce(`导入 ${count} 个物品`); // Fix 2: 恢复播报
                switchScreen('screen-home');
            };
            reader.readAsText(file);
        });

        window.addEventListener('keydown', (e) => {
            if(e.key === 'Escape') {
                const menu = document.getElementById('menu-account-dropdown');
                if (!menu.classList.contains('hidden')) {
                    e.preventDefault();
                    menu.classList.add('hidden');
                    document.getElementById('btn-account-menu').setAttribute('aria-expanded', 'false');
                    document.getElementById('btn-account-menu').focus();
                    return;
                }
                const modals = document.querySelectorAll('[id^="modal-"]:not(.hidden)');
                if (modals.length > 0) {
                    e.preventDefault();
                    closeModals();
                    return;
                }
                // 仅当不在登录或注册页面时才返回首页
                const currentScreen = Array.from(document.querySelectorAll('.screen')).find(el => !el.classList.contains('hidden'));
                if (currentScreen && currentScreen.id !== 'screen-home' && currentScreen.id !== 'screen-login' && currentScreen.id !== 'screen-register') {
                    e.preventDefault();
                    switchScreen('screen-home');
                }
            }
        });
        
        // 初始加载时检查搜索框内容
        document.addEventListener('DOMContentLoaded', updateClearButtonVisibility);
    </script>
</body>
</html>