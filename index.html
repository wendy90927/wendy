<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭物品管家V1.61</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 无障碍专用隐藏 */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* 强焦样式 */
        *:focus {
            outline: 4px solid #f97316; 
            outline-offset: 2px;
            z-index: 100;
        }

        /* 列表卡片 */
        .item-card:focus {
            border-color: #2563eb;
            background-color: #eff6ff;
            transform: scale(1.02);
        }

        /* 数量/单位按钮 */
        .grid-btn {
            height: 60px;
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            background: white;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .grid-btn:hover, .grid-btn:focus {
            background-color: #dbeafe;
            border-color: #2563eb;
            color: #1e40af;
        }

        /* 自定义输入触发器 */
        .custom-input-trigger {
            flex-grow: 1;
            border: 2px solid #e5e7eb;
            padding: 0.5rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            cursor: pointer;
        }
        
        /* 清除按钮样式 */
        .clear-btn {
            position: absolute;
            right: 80px; 
            top: 50%;
            transform: translateY(-50%);
            background: #e5e7eb;
            color: #374151;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
        }
        .clear-btn:hover { background: #d1d5db; }
        .clear-btn.hidden { display: none; }

        /* 标签样式 */
        .tag-bubble {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            background-color: #e0f2fe;
            color: #0369a1;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: bold;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid #bae6fd;
        }
        .tag-remove {
            margin-left: 0.5rem;
            cursor: pointer;
            color: #0284c7;
            padding: 0 0.25rem;
        }
        .tag-remove:hover { color: #dc2626; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">

    <div id="live-announcer" class="sr-only" aria-live="polite"></div>

    <div id="screen-login" class="screen min-h-screen flex flex-col justify-center items-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h1 id="title-login" class="text-3xl font-bold mb-8 text-center outline-none" tabindex="-1">家庭物品管家</h1>
            
            <label for="login-email" class="block mb-2 font-bold text-lg">邮箱账号</label>
            <input type="email" id="login-email" class="w-full p-4 border-2 border-gray-300 rounded-lg mb-6 text-lg" placeholder="name@email.com" aria-label="邮箱账号">
            
            <label for="login-password" class="block mb-2 font-bold text-lg">密码</label>
            <input type="password" id="login-password" class="w-full p-4 border-2 border-gray-300 rounded-lg mb-4 text-lg" placeholder="请输入密码" aria-label="密码">
            
            <div class="flex flex-col gap-3 mb-6">
                <label class="flex items-center gap-3 p-2 border rounded hover:bg-gray-50 cursor-pointer">
                    <input type="checkbox" id="chk-auto-login" class="w-6 h-6 text-blue-600" checked>
                    <span class="font-bold text-lg">自动登录</span>
                </label>
                <label class="flex items-center gap-3 p-2 border rounded hover:bg-gray-50 cursor-pointer">
                    <input type="checkbox" id="chk-remember-email" class="w-6 h-6 text-blue-600">
                    <span class="font-bold text-lg">记住账号</span>
                </label>
            </div>

            <button id="btn-login" class="w-full bg-blue-600 text-white p-4 rounded-lg font-bold text-xl hover:bg-blue-700 mb-4">登录</button>
            
            <div class="flex justify-between mt-4">
                <button id="btn-to-register" class="text-blue-700 font-bold hover:underline p-2">注册新账号</button>
                <button id="btn-forgot-pass" class="text-gray-600 font-bold hover:underline p-2">忘记密码?</button>
            </div>
        </div>
    </div>

    <div id="screen-register" class="screen hidden min-h-screen flex flex-col justify-center items-center p-4 bg-gray-50">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h1 id="title-register" class="text-2xl font-bold mb-6 text-center outline-none" tabindex="-1">注册新账号</h1>
            <label for="reg-email" class="block mb-2 font-bold text-lg">邮箱</label>
            <input type="email" id="reg-email" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 text-lg" aria-label="设置邮箱">
            <label for="reg-pass" class="block mb-2 font-bold text-lg">设置密码 (至少6位)</label>
            <input type="password" id="reg-pass" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 text-lg" aria-label="设置密码">
            <label for="reg-pass-confirm" class="block mb-2 font-bold text-lg">确认密码</label>
            <input type="password" id="reg-pass-confirm" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-8 text-lg" aria-label="确认密码">
            <button id="btn-submit-reg" class="w-full bg-green-600 text-white p-4 rounded-lg font-bold text-xl hover:bg-green-700 mb-4">确认注册</button>
            <button id="btn-back-login" class="w-full bg-gray-200 text-gray-800 p-3 rounded-lg font-bold text-lg">返回登录</button>
        </div>
    </div>

    <div id="screen-home" class="screen hidden min-h-screen flex flex-col pb-20">
        <header class="bg-blue-800 text-white p-4 shadow-md sticky top-0 z-20">
            <div class="max-w-3xl mx-auto flex flex-col gap-4">
                <div class="flex justify-between items-center mb-1 relative">
                    <h1 id="title-home" class="text-xl font-bold outline-none" tabindex="-1">物品管家</h1>
                    <button id="btn-account-menu" aria-haspopup="true" aria-expanded="false" class="text-sm bg-blue-900 hover:bg-blue-700 px-3 py-2 rounded border border-blue-500 font-bold flex items-center gap-2 focus:ring-2 ring-white">
                        <span id="user-email-display">账号</span>
                        <span aria-hidden="true">▼</span>
                    </button>
                    <div id="menu-account-dropdown" class="hidden absolute top-full right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 text-gray-900 z-50 flex flex-col">
                        <button id="btn-clear-data" class="w-full text-left px-4 py-4 hover:bg-red-50 text-red-700 font-bold border-b border-gray-200">清空所有数据</button>
                        <button id="btn-delete-account" class="w-full text-left px-4 py-4 hover:bg-red-50 text-red-700 font-bold border-b border-gray-200">注销账号</button>
                        <button id="btn-logout" class="w-full text-left px-4 py-4 hover:bg-gray-100 font-bold text-gray-800">退出登录</button>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button id="btn-nav-add" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-lg shadow text-xl border-2 border-green-400">+ 新增物品</button>
                    <button id="btn-nav-takeout" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-lg shadow text-xl border-2 border-orange-400">取出物品</button>
                </div>

                <button id="btn-nav-data" class="w-full bg-blue-700 hover:bg-blue-600 text-white py-3 rounded-lg border border-blue-400 font-bold">数据管理</button>

                <div class="relative flex gap-2">
                    <label for="home-search" class="sr-only">搜索物品、分类或标签</label>
                    <input type="text" id="home-search" placeholder="搜索名称、分类或标签..." class="flex-grow p-3 text-black rounded shadow font-bold text-lg pr-12" aria-label="搜索物品">
                    <button id="btn-clear-home-search" class="clear-btn hidden" aria-label="清除搜索内容">X</button>
                    <button id="btn-do-search" class="bg-white text-blue-800 px-4 rounded font-bold shadow">搜索</button>
                </div>
            </div>
        </header>

        <section class="bg-white p-4 shadow-sm border-b z-10">
            <div class="max-w-3xl mx-auto flex flex-col gap-3">
                <div class="flex items-center gap-2">
                    <label for="home-filter" class="font-bold whitespace-nowrap text-lg w-20">房间：</label>
                    <select id="home-filter" autocomplete="off" class="w-full p-3 border-2 border-gray-300 rounded bg-gray-50 text-lg font-bold text-black" aria-label="筛选房间">
                        <option value="all">全部房间</option>
                        <option value="客厅">客厅</option>
                        <option value="厨房">厨房</option>
                        <option value="卧室">卧室</option>
                        <option value="书房">书房</option>
                        <option value="餐厅">餐厅</option>
                        <option value="玄关">玄关</option>
                        <option value="卫生间">卫生间</option>
                        <option value="洗衣房">洗衣房</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <label for="home-filter-cat" class="font-bold whitespace-nowrap text-lg w-20">分类：</label>
                    <select id="home-filter-cat" autocomplete="off" class="w-full p-3 border-2 border-gray-300 rounded bg-gray-50 text-lg font-bold text-black" aria-label="筛选分类">
                        <option value="all">全部分类</option>
                        <option value="食品饮料">食品饮料</option>
                        <option value="居家日用">居家日用</option>
                        <option value="个人护理">个人护理</option>
                        <option value="烹饪调料">烹饪调料</option>
                        <option value="文具工具">文具工具</option>
                        <option value="电子数码">电子数码</option>
                        <option value="其他杂项">其他杂项</option>
                    </select>
                </div>
            </div>
        </section>

        <main class="flex-grow p-4 bg-gray-50">
            <div id="home-list" class="max-w-3xl mx-auto space-y-4" role="list" aria-label="物品列表"></div>
        </main>
    </div>

    <div id="screen-takeout" class="screen hidden min-h-screen flex flex-col pb-20 bg-orange-50">
        <header class="bg-orange-700 text-white p-4 shadow-md sticky top-0 z-20">
            <div class="max-w-3xl mx-auto flex flex-col gap-4">
                <div class="flex items-center justify-between">
                    <button id="btn-back-takeout" class="bg-white text-orange-800 px-6 py-2 rounded-lg font-bold border-2 border-orange-200">&lt; 返回首页</button>
                    <h1 id="title-takeout" class="text-xl font-bold outline-none" tabindex="-1">取出物品</h1>
                </div>

                <div class="relative flex gap-2">
                    <label for="takeout-search" class="sr-only">在取出模式下搜索</label>
                    <input type="text" id="takeout-search" placeholder="输入名称、标签查找..." class="flex-grow p-3 text-black rounded shadow font-bold text-lg pr-12" aria-label="搜索物品">
                    <button id="btn-clear-takeout-search" class="clear-btn hidden" aria-label="清除搜索内容">X</button>
                    <button id="btn-do-search-takeout" class="bg-white text-orange-800 px-4 rounded font-bold shadow">搜索</button>
                </div>
            </div>
        </header>

        <section class="bg-white p-4 shadow-sm border-b z-10">
            <div class="max-w-3xl mx-auto flex flex-col gap-3">
                <div class="flex items-center gap-2">
                    <label for="takeout-filter" class="font-bold whitespace-nowrap text-lg text-orange-900 w-20">房间：</label>
                    <select id="takeout-filter" autocomplete="off" class="w-full p-3 border-2 border-orange-200 rounded bg-orange-50 text-lg font-bold text-black" aria-label="筛选房间">
                        <option value="all">全部房间</option>
                        <option value="客厅">客厅</option><option value="厨房">厨房</option><option value="卧室">卧室</option><option value="书房">书房</option><option value="餐厅">餐厅</option><option value="玄关">玄关</option><option value="卫生间">卫生间</option><option value="洗衣房">洗衣房</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <label for="takeout-filter-cat" class="font-bold whitespace-nowrap text-lg text-orange-900 w-20">分类：</label>
                    <select id="takeout-filter-cat" autocomplete="off" class="w-full p-3 border-2 border-orange-200 rounded bg-orange-50 text-lg font-bold text-black" aria-label="筛选分类">
                        <option value="all">全部分类</option>
                        <option value="食品饮料">食品饮料</option>
                        <option value="居家日用">居家日用</option>
                        <option value="个人护理">个人护理</option>
                        <option value="烹饪调料">烹饪调料</option>
                        <option value="文具工具">文具工具</option>
                        <option value="电子数码">电子数码</option>
                        <option value="其他杂项">其他杂项</option>
                    </select>
                </div>
            </div>
        </section>

        <main class="flex-grow p-4">
            <div id="takeout-list" class="max-w-3xl mx-auto space-y-4" role="list" aria-label="可取出物品列表"></div>
        </main>
    </div>

    <div id="screen-results" class="screen hidden min-h-screen flex flex-col bg-gray-100">
        <div class="bg-purple-700 text-white p-4 shadow-md sticky top-0 z-20">
            <div class="max-w-3xl mx-auto flex flex-col gap-4">
                <div class="flex items-center justify-between">
                    <button id="btn-back-results" class="bg-white text-purple-800 px-6 py-2 rounded-lg font-bold border-2 border-purple-200">&lt; 返回</button>
                    <h1 id="title-results" class="text-xl font-bold outline-none" tabindex="-1">搜索结果</h1>
                </div>
            </div>
        </div>
        <main class="flex-grow p-4 bg-gray-50 overflow-y-auto">
            <div id="results-stats" class="max-w-3xl mx-auto mb-4 p-4 bg-purple-50 border-l-4 border-purple-500 rounded shadow text-lg font-bold" aria-live="polite">
                正在计算...
            </div>
            <div id="results-list" class="max-w-3xl mx-auto space-y-4" role="list" aria-label="搜索结果列表"></div>
        </main>
    </div>

    <div id="screen-add" class="screen hidden min-h-screen flex flex-col bg-white">
        <div class="bg-green-600 text-white p-4 shadow-md sticky top-0 z-20">
            <div class="max-w-3xl mx-auto flex items-center justify-between">
                <button id="btn-back-add" class="bg-white text-green-700 px-6 py-2 rounded-lg font-bold border-2 border-green-200">&lt; 返回首页</button>
                <h1 id="title-add" class="text-xl font-bold outline-none" tabindex="-1">新增物品</h1>
            </div>
        </div>
            if(currentActionItem) focusTargetId = currentActionItem.id;
            switchScreen('screen-' + previousScreen);
        }
        document.getElementById('btn-back-edit').addEventListener('click', cancelEdit);
        document.getElementById('btn-cancel-edit-form').addEventListener('click', cancelEdit);

        // Unit Picker
        let unitTargetInput = null;
        const unitGrid = document.getElementById('unit-grid');
        function initUnitGrid() {
            unitGrid.innerHTML = '';
            UNIT_LIST.forEach(u => {
                const btn = document.createElement('button');
                btn.className = 'grid-btn'; btn.textContent = u;
                btn.addEventListener('click', () => {
                    if(unitTargetInput) { unitTargetInput.value = u; announce(`已选择 ${u}`); unitTargetInput.focus(); }
                    closeUnitModal();
                });
                unitGrid.appendChild(btn);
            });
        }
        window.openUnitPicker = (inputId) => {
            playSound('click'); unitTargetInput = document.getElementById(inputId); initUnitGrid(); 
            document.getElementById('modal-unit').classList.remove('hidden'); document.getElementById('unit-title').focus();
        };
        window.closeUnitModal = () => { document.getElementById('modal-unit').classList.add('hidden'); if(unitTargetInput) unitTargetInput.focus(); };
        document.getElementById('btn-pick-unit-add').addEventListener('click', () => openUnitPicker('add-unit'));
        document.getElementById('btn-pick-unit-edit').addEventListener('click', () => openUnitPicker('edit-unit'));

        // Edit Execution
        document.getElementById('form-edit').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newQty = parseInt(document.getElementById('edit-quantity').value);
            const unitVal = document.getElementById('edit-unit').value;
            learnNewUnit(unitVal);
            if (newQty === 0) { openZeroConfirmEdit(newQty); return; }
            await executeEdit(newQty);
        });

        async function executeEdit(newQty) {
            focusTargetId = currentActionItem.id; 
            try {
                await updateDoc(doc(db, "items", currentActionItem.id), {
                    name: document.getElementById('edit-name').value,
                    category: document.getElementById('edit-category').value, 
                    tags: pendingTags, 
                    room: document.getElementById('edit-room').value,
                    location: document.getElementById('edit-location').value,
                    unit: document.getElementById('edit-unit').value,
                    quantity: newQty,
                    updatedAt: serverTimestamp()
                });
                announce("修改成功");
                switchScreen('screen-' + previousScreen);
            } catch(e) { announce("失败"); }
        }

        function openZeroConfirmEdit(newQty) {
            const m = document.getElementById('modal-zero'); playSound('error'); m.classList.remove('hidden'); setTimeout(() => document.getElementById('title-zero').focus(), 100);
            document.getElementById('btn-zero-keep').onclick = async () => { m.classList.add('hidden'); await executeEdit(0); };
            document.getElementById('btn-zero-del').onclick = async () => { m.classList.add('hidden'); await execDelete(); switchScreen('screen-' + previousScreen); };
            document.getElementById('btn-zero-cancel').onclick = () => { m.classList.add('hidden'); announce("已取消"); };
        }

        // Action Menu
        function openActionMenu(item) {
            playSound('click');
            
            // --- 修复 BUG 1：获取最新数据 ---
            const freshItem = allItems.find(i => i.id === item.id) || item;
            currentActionItem = freshItem;
            // -----------------------------

            const modal = document.getElementById('modal-action');
            document.getElementById('action-title').textContent = `管理：${freshItem.name}`;
            document.getElementById('action-desc').textContent = `分类：${freshItem.category} | 剩余：${freshItem.quantity} ${freshItem.unit||'个'}`;
            const btnPut = document.getElementById('btn-act-put');
            if (currentScreen === 'takeout') btnPut.classList.add('hidden'); else btnPut.classList.remove('hidden'); 
            modal.classList.remove('hidden');
            setTimeout(() => { const v = modal.querySelectorAll('button:not(.hidden)'); if(v.length > 0) v[0].focus(); }, 100);
        }
        document.getElementById('action-buttons-container').addEventListener('click', (e) => {
            const btn = e.target.closest('button'); if (!btn) return;
            const act = btn.dataset.action;
            if (act === 'put') openQtyPicker("放入数量", (n) => handleUpdate(n));
            if (act === 'take') openQtyPicker("取出数量", (n) => handleUpdate(-n));
            if (act === 'delete') openGenericConfirm(`确定删除 ${currentActionItem.name} 吗？`, execDelete);
            if (act === 'edit') openEditScreen(currentActionItem);
        });

        function openEditScreen(item) {
            document.getElementById('modal-action').classList.add('hidden');
            switchScreen('screen-edit');
            document.getElementById('edit-name').value = item.name;
            const catSelect = document.getElementById('edit-category');
            catSelect.value = item.category || '其他杂项';
            if(catSelect.value === '') catSelect.value = '其他杂项';

            document.getElementById('edit-room').value = item.room;
            document.getElementById('edit-location').value = item.location;
            document.getElementById('edit-unit').value = item.unit || '个';
            document.getElementById('edit-quantity').value = item.quantity;
            pendingTags = [...(item.tags || [])];
            renderTags('edit-tags-container', 'edit-tags-input');
        }

        // Qty Picker (Same logic)
        let qtyCallback = null;
        const qtyGrid = document.getElementById('qty-grid');
        qtyGrid.innerHTML = '';
        for(let i=1; i<=10; i++) {
            const btn = document.createElement('button'); btn.className = 'grid-btn'; btn.textContent = i;
            const handler = (e) => { if(e.type === 'keydown' && e.key !== 'Enter') return; e.preventDefault(); e.stopPropagation(); submitQty(i); };
            btn.addEventListener('click', handler); btn.addEventListener('keydown', handler); qtyGrid.appendChild(btn);
        }
        function openQtyPicker(title, cb) {
            playSound('click'); qtyCallback = cb;
            document.getElementById('qty-title').textContent = title;
            document.getElementById('modal-action').classList.add('hidden'); document.getElementById('modal-qty').classList.remove('hidden');
            const input = document.getElementById('qty-custom-input'); const confirm = document.getElementById('btn-qty-confirm'); const trigger = document.getElementById('qty-custom-trigger');
            input.value = ''; input.disabled = true; confirm.disabled = true; confirm.classList.add('opacity-50'); confirm.setAttribute('tabindex', '-1'); trigger.setAttribute('tabindex', '0');
            setTimeout(() => { qtyGrid.firstChild.focus(); announce("请选择数量"); }, 100);
        }
        const customTrigger = document.getElementById('qty-custom-trigger');
        function activateInput() {
            const input = document.getElementById('qty-custom-input'); const confirm = document.getElementById('btn-qty-confirm'); const trigger = document.getElementById('qty-custom-trigger');
            trigger.setAttribute('tabindex', '-1'); input.disabled = false; input.focus(); confirm.disabled = false; confirm.classList.remove('opacity-50'); confirm.setAttribute('tabindex', '0'); announce("请输入数字");
        }
        customTrigger.addEventListener('click', activateInput);
        customTrigger.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.keyCode === 13) { e.preventDefault(); e.stopPropagation(); activateInput(); } });
        document.getElementById('qty-custom-input').addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.keyCode === 13) { e.preventDefault(); e.stopPropagation(); submitQty(parseInt(e.target.value)); } });
        document.getElementById('btn-qty-confirm').addEventListener('click', () => { submitQty(parseInt(document.getElementById('qty-custom-input').value)); });
        function submitQty(val) { if (!val || val <= 0) { announce("无效数量"); return; } if (qtyCallback) qtyCallback(val); document.getElementById('modal-qty').classList.add('hidden'); }
        function closeQtyModal() { document.getElementById('modal-qty').classList.add('hidden'); closeModals(); }

        window.closeModals = () => {
            document.querySelectorAll('[id^="modal-"]').forEach(m => m.classList.add('hidden'));
            const containerId = (currentScreen === 'results') ? 'results-list' : (currentScreen === 'takeout' ? 'takeout-list' : 'home-list');
            const container = document.getElementById(containerId);
            if (currentActionItem && currentActionItem.id) {
                const target = container.querySelector(`.item-card[data-id="${currentActionItem.id}"]`);
                if (target) { target.focus(); return; }
            }
            const first = container.querySelector('.item-card');
            if (first) first.focus();
        };

        async function handleUpdate(change) {
            if (!currentActionItem) return;
            const newQty = currentActionItem.quantity + change;
            if (newQty === 0) { openZeroConfirm(); return; }
            if (newQty < 0) { announce("库存不足"); return; }
            await execUpdate(change);
        }
        async function execUpdate(change) {
            focusTargetId = currentActionItem.id;
            try {
                await updateDoc(doc(db, "items", currentActionItem.id), { quantity: increment(change), updatedAt: serverTimestamp() });
                announce("更新成功"); closeModals();
            } catch(e) { announce("失败"); }
        }
        function openZeroConfirm() {
            const m = document.getElementById('modal-zero'); playSound('error'); m.classList.remove('hidden'); setTimeout(() => document.getElementById('title-zero').focus(), 100);
            document.getElementById('btn-zero-keep').onclick = async () => { m.classList.add('hidden'); await execUpdate(-currentActionItem.quantity); };
            document.getElementById('btn-zero-del').onclick = async () => { m.classList.add('hidden'); await execDelete(); };
            document.getElementById('btn-zero-cancel').onclick = () => { m.classList.add('hidden'); announce("已取消"); closeModals(); };
        }
        let confirmCallback = null;
        function openGenericConfirm(msg, cb) {
            document.getElementById('modal-action').classList.add('hidden'); const m = document.getElementById('modal-confirm'); playSound('error');
            m.classList.remove('hidden'); document.getElementById('confirm-text').textContent = msg; confirmCallback = cb; setTimeout(() => document.getElementById('title-confirm').focus(), 100);
        }
        document.getElementById('btn-confirm-ok').addEventListener('click', () => { if(confirmCallback) confirmCallback(); document.getElementById('modal-confirm').classList.add('hidden'); });
        document.getElementById('btn-confirm-cancel').addEventListener('click', () => closeModals());
        async function execDelete() { try { await deleteDoc(doc(db, "items", currentActionItem.id)); announce("已删除"); closeModals(); } catch(e) { announce("删除失败"); } }

        // Export/Import
        document.getElementById('btn-export').addEventListener('click', () => {
            let csvContent = "\uFEFF物品名称,分类,标签,房间,具体位置,数量,单位\n"; 
            allItems.forEach(item => { 
                const tagsStr = (item.tags || []).join(';');
                csvContent += `${item.name},${item.category},${tagsStr},${item.room},${item.location || ''},${item.quantity},${item.unit||'个'}\n`; 
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.setAttribute("href", url); link.setAttribute("download", `物品备份_${new Date().toISOString().slice(0,10)}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); announce("导出成功");
        });
        document.getElementById('btn-download-template').addEventListener('click', () => {
            const csvContent = "\uFEFF物品名称(必填),分类,标签(用分号隔开),房间(必填),具体位置,数量(数字),单位\n大米,食品饮料,粮食;主食,厨房,米桶,1,袋\n洗发水,个人护理,洗护;日常,卫生间,架子,1,瓶"; 
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.setAttribute("href", url); link.setAttribute("download", `导入模板.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); announce("模板下载成功");
        });
        document.getElementById('btn-trigger-upload').addEventListener('click', () => document.getElementById('file-upload').click());
        document.getElementById('file-upload').addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result; const rows = text.split('\n'); let count = 0;
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i].trim(); if (!row) continue; const cols = row.split(','); if (cols.length < 1) continue; const name = cols[0]?.trim(); if(!name) continue;
                    
                    const cat = cols[1]?.trim() || '其他杂项';
                    const tagStr = cols[2]?.trim() || '';
                    const tags = tagStr ? tagStr.split(';').map(t => t.trim()).filter(t=>t) : [];

                    await addDoc(itemsRef, { 
                        name: name, 
                        category: cat,
                        tags: tags,
                        room: cols[3]?.trim() || '客厅', 
                        location: cols[4]?.trim() || '', 
                        quantity: parseInt(cols[5]) || 1, 
                        unit: cols[6]?.trim() || '个', 
                        uid: auth.currentUser.uid, 
                        updatedAt: serverTimestamp() 
                    }); count++;
                } announce(`导入 ${count} 个物品`); switchScreen('screen-home');
            }; reader.readAsText(file);
        });

        // Global Keydown
        window.addEventListener('keydown', (e) => {
            if(e.key === 'Escape') {
                if (currentScreen === 'edit') return; 
                const menu = document.getElementById('menu-account-dropdown');
                if (!menu.classList.contains('hidden')) { e.preventDefault(); menu.classList.add('hidden'); document.getElementById('btn-account-menu').setAttribute('aria-expanded', 'false'); document.getElementById('btn-account-menu').focus(); return; }
                const modals = document.querySelectorAll('[id^="modal-"]:not(.hidden)'); if (modals.length > 0) { e.preventDefault(); closeModals(); document.getElementById('modal-qty').classList.add('hidden'); document.getElementById('modal-unit').classList.add('hidden'); return; }
                if (currentScreen !== 'home' && currentScreen !== 'login') { 
                    document.getElementById('home-search').value = ''; document.getElementById('takeout-search').value = '';
                    document.getElementById('btn-clear-home-search').classList.add('hidden'); document.getElementById('btn-clear-takeout-search').classList.add('hidden');
                    e.preventDefault(); switchScreen('screen-home'); 
                }
            }
        });
    </script>
</body>
</html>