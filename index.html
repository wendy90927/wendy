<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>王府物品管家</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* 强焦样式：确保盲人用户能清楚看到当前焦点 */
        *:focus {
            outline: 4px solid #f97316; /* 橙色高亮，加粗 */
            outline-offset: 2px;
            z-index: 50;
        }

        .item-card:focus {
            border-color: #2563eb;
            background-color: #eff6ff;
            transform: scale(1.02);
        }

        /* 数量按钮样式 */
        .qty-btn {
            height: 55px;
            font-size: 1.25rem;
            font-weight: bold;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            background: white;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        /* 当按钮获得焦点时 */
        .qty-btn:focus, .qty-btn:hover {
            background-color: #dbeafe;
            border-color: #2563eb;
            color: #1e40af;
        }

        /* 自定义输入容器 */
        .custom-input-trigger {
            flex-grow: 1;
            border: 2px solid #e5e7eb;
            padding: 0.5rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            cursor: pointer;
        }
        .custom-input-trigger:focus {
            border-color: #2563eb;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">

    <div id="live-announcer" class="sr-only" aria-live="polite"></div>

    <div id="screen-login" class="min-h-screen flex flex-col justify-center items-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h1 class="text-3xl font-bold mb-8 text-center" tabindex="-1">家庭物品管家</h1>
            <label class="block mb-2 font-bold text-lg">邮箱账号</label>
            <input type="email" id="login-email" class="w-full p-4 border-2 border-gray-300 rounded mb-6 text-lg" placeholder="例如：888@home.com">
            <label class="block mb-2 font-bold text-lg">家庭密码</label>
            <input type="password" id="login-password" class="w-full p-4 border-2 border-gray-300 rounded mb-8 text-lg" placeholder="请输入密码">
            <button id="btn-login" class="w-full bg-blue-600 text-white p-4 rounded-lg font-bold text-xl hover:bg-blue-700">登录系统</button>
        </div>
    </div>

    <div id="screen-home" class="hidden min-h-screen flex flex-col pb-20">
        <header class="bg-blue-800 text-white p-4 shadow-md sticky top-0 z-20">
            <div class="max-w-3xl mx-auto flex flex-col gap-4">
                
                <h1 class="text-xl font-bold text-center mb-2">物品管家</h1>

                <div class="flex gap-3">
                    <button id="btn-nav-add" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded shadow text-xl border-2 border-green-400">
                        + 新增物品
                    </button>
                    <button id="btn-nav-takeout" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded shadow text-xl border-2 border-orange-400">
                        - 取出物品
                    </button>
                </div>

                <button id="btn-nav-data" class="w-full bg-blue-700 hover:bg-blue-600 text-white py-3 rounded border border-blue-400 font-bold">
                    数据管理 (导入/导出)
                </button>

                <input type="text" id="home-search" placeholder="输入物品名称搜索..." class="w-full p-3 text-black rounded shadow font-bold text-lg" aria-label="搜索物品">
            </div>
        </header>

        <section class="bg-white p-4 shadow-sm border-b z-10">
            <div class="max-w-3xl mx-auto flex items-center gap-2">
                <label for="home-filter" class="font-bold whitespace-nowrap text-lg">房间筛选：</label>
                <select id="home-filter" autocomplete="off" class="w-full p-3 border-2 border-gray-300 rounded bg-gray-50 text-lg font-bold">
                    <option value="all">全部房间</option>
                    <option value="客厅">客厅</option>
                    <option value="厨房">厨房</option>
                    <option value="卧室">卧室</option>
                    <option value="书房">书房</option>
                    <option value="餐厅">餐厅</option>
                    <option value="玄关">玄关</option>
                    <option value="卫生间">卫生间</option>
                    <option value="洗衣房">洗衣房</option>
                </select>
            </div>
        </section>

        <main class="flex-grow p-4 bg-gray-50">
            <div id="home-list" class="max-w-3xl mx-auto space-y-4" role="list" aria-label="物品列表"></div>
        </main>
    </div>

    <div id="screen-takeout" class="hidden min-h-screen flex flex-col bg-gray-100">
        <div class="bg-orange-600 text-white p-4 shadow-md sticky top-0 z-20">
            <div class="max-w-3xl mx-auto flex flex-col gap-4">
                <div class="flex items-center justify-between">
                    <button id="btn-back-takeout" class="bg-white text-orange-700 px-6 py-2 rounded-lg font-bold border-2 border-orange-200">
                        &lt; 返回首页
                    </button>
                    <h2 class="text-xl font-bold" aria-hidden="true">取出</h2>
                </div>
                <input type="text" id="takeout-search" placeholder="搜索要取出的物品..." class="w-full p-3 text-black rounded shadow font-bold text-lg" aria-label="搜索要取出的物品">
            </div>
        </div>

        <section class="bg-white p-4 shadow-sm border-b z-10">
            <div class="max-w-3xl mx-auto flex items-center gap-2">
                <label for="takeout-filter" class="font-bold whitespace-nowrap text-lg">房间：</label>
                <select id="takeout-filter" autocomplete="off" class="w-full p-3 border-2 border-gray-300 rounded bg-gray-50 text-lg font-bold">
                    <option value="all">全部房间</option>
                    <option value="客厅">客厅</option>
                    <option value="厨房">厨房</option>
                    <option value="卧室">卧室</option>
                    <option value="书房">书房</option>
                    <option value="餐厅">餐厅</option>
                    <option value="玄关">玄关</option>
                    <option value="卫生间">卫生间</option>
                    <option value="洗衣房">洗衣房</option>
                </select>
            </div>
        </section>

        <main class="flex-grow p-4 bg-gray-50 overflow-y-auto">
            <div id="takeout-list" class="max-w-3xl mx-auto space-y-4" role="list" aria-label="搜索结果列表">
                <p class="text-center text-gray-500 mt-10 text-lg">加载中...</p>
            </div>
        </main>
    </div>

    <div id="screen-add" class="hidden min-h-screen flex flex-col bg-white">
        <div class="bg-green-600 text-white p-4 shadow-md sticky top-0 z-20">
            <div class="max-w-3xl mx-auto flex items-center justify-between">
                <button id="btn-back-add" class="bg-white text-green-700 px-6 py-2 rounded-lg font-bold border-2 border-green-200">
                    &lt; 返回首页
                </button>
                <h2 class="text-xl font-bold">新增物品</h2>
            </div>
        </div>
        
        <div class="max-w-lg mx-auto w-full p-6 overflow-y-auto">
            <form id="form-add" class="space-y-6">
                <div>
                    <label class="block font-bold mb-2 text-xl">物品名称 (必填)</label>
                    <input type="text" id="add-name" required class="w-full p-4 border-2 border-gray-300 rounded-lg text-xl" placeholder="如：大米">
                </div>
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label class="block font-bold mb-2 text-xl">房间</label>
                        <select id="add-room" class="w-full p-4 border-2 border-gray-300 rounded-lg text-xl bg-white">
                            <option value="厨房">厨房</option>
                            <option value="客厅">客厅</option>
                            <option value="卧室">卧室</option>
                            <option value="书房">书房</option>
                            <option value="餐厅">餐厅</option>
                            <option value="玄关">玄关</option>
                            <option value="卫生间">卫生间</option>
                            <option value="洗衣房">洗衣房</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-bold mb-2 text-xl">具体位置</label>
                        <input type="text" id="add-location" class="w-full p-4 border-2 border-gray-300 rounded-lg text-xl" placeholder="如：柜子第二层">
                    </div>
                </div>
                <div>
                    <label class="block font-bold mb-2 text-xl">初始数量</label>
                    <button type="button" id="btn-add-qty-trigger" class="w-full p-4 border-2 border-blue-300 bg-blue-50 text-blue-900 font-bold text-left text-xl rounded-lg">
                        当前选择：1 (点击修改)
                    </button>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white p-5 rounded-lg font-bold text-2xl mt-8 shadow-lg">
                    保存并继续
                </button>
            </form>
        </div>
    </div>

    <div id="screen-data" class="hidden min-h-screen flex flex-col bg-white">
        <div class="bg-blue-700 text-white p-4 shadow-md sticky top-0 z-20">
            <div class="max-w-3xl mx-auto flex items-center justify-between">
                <button id="btn-back-data" class="bg-white text-blue-700 px-6 py-2 rounded-lg font-bold border-2 border-blue-200">
                    &lt; 返回首页
                </button>
                <h2 class="text-xl font-bold">数据管理</h2>
            </div>
        </div>

        <div class="max-w-lg mx-auto w-full p-8 flex flex-col gap-6 mt-10">
            <button id="btn-export" class="w-full p-6 bg-green-50 border-2 border-green-500 text-green-900 font-bold rounded-xl text-xl hover:bg-green-100 shadow-sm text-left">
                ⬇ 导出备份数据 (CSV)
            </button>
            
            <hr class="border-gray-200 my-2">
            
            <p class="text-lg font-bold text-gray-700">批量导入数据：</p>
            
            <button id="btn-download-template" class="w-full p-6 bg-gray-50 border-2 border-gray-400 text-gray-800 font-bold rounded-xl text-xl hover:bg-gray-100 shadow-sm text-left">
                下载导入模板
            </button>
            
            <button id="btn-trigger-upload" class="w-full p-6 bg-blue-50 border-2 border-blue-500 text-blue-900 font-bold rounded-xl text-xl hover:bg-blue-100 shadow-sm text-left">
                上传填写好的文件
            </button>
            
            <input type="file" id="file-upload" accept=".csv" class="hidden">
        </div>
    </div>

    <div id="modal-action" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl text-center border-4 border-gray-300">
            <h2 id="action-title" class="text-2xl font-bold mb-2 text-gray-900" tabindex="-1">管理物品</h2>
            <p id="action-desc" class="text-lg text-gray-600 mb-6">详情</p>
            <div class="flex flex-col gap-4" id="action-buttons-container">
                <button id="btn-act-put" class="p-4 bg-blue-100 text-blue-900 font-bold rounded-xl border-2 border-blue-300 text-xl" data-action="put">放入 (增加)</button>
                <button id="btn-act-take" class="p-4 bg-orange-100 text-orange-900 font-bold rounded-xl border-2 border-orange-300 text-xl" data-action="take">取出 (减少)</button>
                <button id="btn-act-del" class="p-4 bg-red-100 text-red-900 font-bold rounded-xl border-2 border-red-300 text-xl" data-action="delete">删除物品</button>
                <button class="p-4 bg-gray-100 text-gray-800 font-bold rounded-xl border-2 border-gray-300 text-xl mt-2" onclick="closeModals()">取消</button>
            </div>
        </div>
    </div>

    <div id="modal-qty" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex justify-center items-end sm:items-center">
        <div class="bg-white w-full max-w-md p-6 rounded-t-2xl sm:rounded-2xl shadow-2xl border-t-4 border-blue-500">
            <h2 id="qty-title" class="text-2xl font-bold mb-6 text-center text-gray-900" tabindex="-1">选择数量</h2>
            
            <div class="grid grid-cols-5 gap-3 mb-6" id="qty-grid"></div>

            <div class="flex gap-2 mb-6 items-stretch">
                <div id="qty-custom-trigger" class="custom-input-trigger" role="button" tabindex="0" aria-label="自定义数量，按回车输入">
                    <span class="mr-2 font-bold text-gray-700 text-lg">自定义:</span>
                    <input type="number" id="qty-custom-input" class="w-24 p-2 border-b-4 border-gray-400 text-center font-bold text-xl bg-gray-50 text-black" disabled placeholder="#" tabindex="-1">
                </div>
                <button id="btn-qty-confirm" class="bg-blue-600 text-white font-bold px-6 rounded-lg shadow-lg disabled:opacity-50 text-lg" disabled tabindex="-1">
                    确定
                </button>
            </div>

            <button class="w-full p-4 bg-gray-200 text-gray-800 rounded-xl font-bold text-xl" onclick="closeQtyModal()">取消</button>
        </div>
    </div>

    <div id="modal-zero" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl text-center border-4 border-orange-400">
            <h2 class="text-2xl font-bold mb-4 text-orange-700" tabindex="-1">数量已空</h2>
            <p class="mb-6 text-gray-800 text-lg">物品数量已归零，请选择操作：</p>
            <div class="flex flex-col gap-4">
                <button id="btn-zero-keep" class="p-4 bg-blue-100 text-blue-900 rounded-xl font-bold border-2 border-blue-200 text-lg">保留物品 (数量设为0)</button>
                <button id="btn-zero-del" class="p-4 bg-red-100 text-red-900 rounded-xl font-bold border-2 border-red-200 text-lg">删除物品</button>
                <button id="btn-zero-cancel" class="p-4 bg-gray-200 text-gray-900 rounded-xl font-bold border-2 border-gray-300 text-lg">取消操作 (撤销)</button>
            </div>
        </div>
    </div>

    <div id="modal-confirm" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl text-center border-4 border-red-400">
            <h2 class="text-2xl font-bold mb-4 text-red-700" tabindex="-1">⚠ 确定删除吗？</h2>
            <p id="confirm-text" class="mb-6 text-gray-800 text-lg"></p>
            <div class="flex gap-4">
                <button class="flex-1 p-4 bg-gray-200 rounded-xl font-bold text-lg" onclick="closeModals()">取消</button>
                <button id="btn-confirm-del" class="flex-1 p-4 bg-red-600 text-white rounded-xl font-bold text-lg shadow">确认删除</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 配置
        const firebaseConfig = {
            apiKey: "AIzaSyC3rxfvajIswJADfzJD0lphVra99vka7nE",
            authDomain: "household-item-management.firebaseapp.com",
            projectId: "household-item-management",
            storageBucket: "household-item-management.firebasestorage.app",
            messagingSenderId: "1042289941268",
            appId: "1:1042289941268:web:2d77a3a9fb2cf666ed0001"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const itemsRef = collection(db, "items");

        // 全局状态
        let allItems = [];
        let currentActionItem = null;
        let pendingAddQty = 1;
        let currentScreen = 'home';
        let homeFilterRoom = 'all';
        let takeoutFilterRoom = 'all';

        // 语音
        window.announce = (msg) => {
            const el = document.getElementById('live-announcer');
            el.textContent = msg;
            setTimeout(() => el.textContent = '', 1000);
        };

        // --- 屏幕切换系统 (防穿透核心) ---
        function switchScreen(screenId) {
            // 隐藏所有
            ['screen-login', 'screen-home', 'screen-takeout', 'screen-add', 'screen-data'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            // 显示目标
            const target = document.getElementById(screenId);
            target.classList.remove('hidden');
            
            // 焦点管理：聚焦到第一个按钮
            setTimeout(() => {
                const firstBtn = target.querySelector('button');
                if (firstBtn) firstBtn.focus();
            }, 100);

            if (screenId === 'screen-home') currentScreen = 'home';
            if (screenId === 'screen-takeout') currentScreen = 'takeout';
            
            refreshLists();
        }

        // --- 登录 ---
        onAuthStateChanged(auth, user => {
            if (user) {
                switchScreen('screen-home');
                loadItems();
            } else {
                switchScreen('screen-login');
            }
        });
        document.getElementById('btn-login').addEventListener('click', () => {
            const e = document.getElementById('login-email').value;
            const p = document.getElementById('login-password').value;
            signInWithEmailAndPassword(auth, e, p).catch(() => announce("登录失败"));
        });

        // --- 数据加载 ---
        function loadItems() {
            onSnapshot(query(itemsRef, orderBy("updatedAt", "desc")), snap => {
                allItems = [];
                snap.forEach(d => allItems.push({ id: d.id, ...d.data() }));
                refreshLists();
            });
        }

        function refreshLists() {
            if (currentScreen === 'home') renderList('home-list', 'home-search', 'home-filter', homeFilterRoom);
            if (currentScreen === 'takeout') renderList('takeout-list', 'takeout-search', 'takeout-filter', takeoutFilterRoom);
        }

        // --- 列表渲染 ---
        function renderList(containerId, searchId, filterId, currentRoomFilter) {
            const container = document.getElementById(containerId);
            const searchVal = document.getElementById(searchId).value.trim().toLowerCase();
            const selectEl = document.getElementById(filterId);
            if (selectEl.value !== currentRoomFilter) selectEl.value = currentRoomFilter;

            const filtered = allItems.filter(item => {
                const matchSearch = item.name.toLowerCase().includes(searchVal) || (item.location||'').toLowerCase().includes(searchVal);
                const matchRoom = currentRoomFilter === 'all' || item.room === currentRoomFilter;
                return matchSearch && matchRoom;
            });

            container.innerHTML = '';
            if (filtered.length === 0) {
                container.innerHTML = `<div class="text-center p-6 text-gray-500 text-lg">未找到物品</div>`;
                return;
            }

            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = "item-card bg-white p-4 rounded-lg shadow border-l-8 border-blue-500 cursor-pointer relative";
                div.setAttribute('role', 'button');
                div.setAttribute('tabindex', '0');
                div.setAttribute('aria-label', `${item.name}，位于 ${item.room} 的 ${item.location || '未知位置'}，剩余 ${item.quantity} 个。按回车管理。`);
                
                div.innerHTML = `
                    <div class="flex justify-between items-center pointer-events-none">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">${item.name}</h3>
                            <p class="text-base text-gray-600 font-bold">${item.room} - ${item.location || '位置未填'}</p>
                        </div>
                        <div class="text-3xl font-bold text-blue-700">${item.quantity}</div>
                    </div>
                `;
                
                const triggerMenu = () => openActionMenu(item);
                div.addEventListener('click', triggerMenu);
                div.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        triggerMenu();
                    }
                });
                container.appendChild(div);
            });
        }

        // 监听
        function setupListListeners(searchId, filterId, screenType) {
            document.getElementById(searchId).addEventListener('input', () => refreshLists());
            document.getElementById(filterId).addEventListener('change', (e) => {
                if (screenType === 'home') homeFilterRoom = e.target.value;
                if (screenType === 'takeout') takeoutFilterRoom = e.target.value;
                refreshLists();
            });
        }
        setupListListeners('home-search', 'home-filter', 'home');
        setupListListeners('takeout-search', 'takeout-filter', 'takeout');

        // --- 页面跳转逻辑 ---
        document.getElementById('btn-nav-takeout').addEventListener('click', () => {
            switchScreen('screen-takeout');
            document.getElementById('takeout-search').value = '';
            refreshLists();
        });
        document.getElementById('btn-back-takeout').addEventListener('click', () => switchScreen('screen-home'));

        document.getElementById('btn-nav-add').addEventListener('click', () => {
            switchScreen('screen-add');
            document.getElementById('add-name').focus();
            pendingAddQty = 1;
            updateAddQtyDisplay();
        });
        document.getElementById('btn-back-add').addEventListener('click', () => switchScreen('screen-home'));
        
        document.getElementById('btn-nav-data').addEventListener('click', () => {
            switchScreen('screen-data');
        });
        document.getElementById('btn-back-data').addEventListener('click', () => switchScreen('screen-home'));

        // --- 操作菜单 ---
        function openActionMenu(item) {
            currentActionItem = item;
            const modal = document.getElementById('modal-action');
            document.getElementById('action-title').textContent = `管理：${item.name}`;
            document.getElementById('action-desc').textContent = `剩余：${item.quantity}`;
            
            const btnPut = document.getElementById('btn-act-put');
            if (currentScreen === 'takeout') btnPut.classList.add('hidden');
            else btnPut.classList.remove('hidden');

            modal.classList.remove('hidden');
            const visible = modal.querySelectorAll('button:not(.hidden)');
            if(visible.length > 0) setTimeout(() => visible[0].focus(), 100);
        }

        document.getElementById('action-buttons-container').addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const act = btn.dataset.action;
            if (act === 'put') openQtyPicker("放入数量", (n) => handleUpdate(n));
            if (act === 'take') openQtyPicker("取出数量", (n) => handleUpdate(-n));
            if (act === 'delete') openConfirm(currentActionItem);
        });

        // --- 数量选择器 (焦点直接绑定法) ---
        let qtyCallback = null;
        const qtyGrid = document.getElementById('qty-grid');
        
        // 生成 1-10，直接绑定事件，不依赖全局监听
        qtyGrid.innerHTML = '';
        for(let i=1; i<=10; i++) {
            const btn = document.createElement('button'); // 使用真正的 button 获得原生行为
            btn.className = 'qty-btn';
            btn.textContent = i;
            // 绑定 Click
            btn.addEventListener('click', () => submitQty(i));
            // 绑定 Enter (虽然 button 默认支持，但为了保险)
            btn.addEventListener('keydown', (e) => {
                if(e.key === 'Enter') {
                    e.preventDefault(); e.stopPropagation();
                    submitQty(i);
                }
            });
            qtyGrid.appendChild(btn);
        }

        function openQtyPicker(title, cb) {
            qtyCallback = cb;
            document.getElementById('qty-title').textContent = title;
            document.getElementById('modal-action').classList.add('hidden');
            const modal = document.getElementById('modal-qty');
            modal.classList.remove('hidden');
            
            // 重置
            const input = document.getElementById('qty-custom-input');
            const confirm = document.getElementById('btn-qty-confirm');
            const trigger = document.getElementById('qty-custom-trigger');
            
            input.value = '';
            input.disabled = true;
            confirm.disabled = true;
            confirm.classList.add('opacity-50');
            confirm.setAttribute('tabindex', '-1');
            trigger.setAttribute('tabindex', '0'); // 允许聚焦触发器
            
            // 默认聚焦数字 1
            setTimeout(() => {
                qtyGrid.firstChild.focus();
                announce("请选择数量");
            }, 100);
        }

        // 自定义输入逻辑 (强拦截)
        const customTrigger = document.getElementById('qty-custom-trigger');
        
        function activateInput() {
            const input = document.getElementById('qty-custom-input');
            const confirm = document.getElementById('btn-qty-confirm');
            const trigger = document.getElementById('qty-custom-trigger');
            
            trigger.setAttribute('tabindex', '-1'); // 暂时不可聚焦
            input.disabled = false;
            input.focus();
            
            confirm.disabled = false;
            confirm.classList.remove('opacity-50');
            confirm.setAttribute('tabindex', '0');
            announce("请输入数字");
        }

        customTrigger.addEventListener('click', activateInput);
        customTrigger.addEventListener('keydown', (e) => {
            // 拦截所有回车
            if(e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault(); e.stopPropagation(); // 关键！
                activateInput();
            }
        });

        // 输入框内的回车
        document.getElementById('qty-custom-input').addEventListener('keydown', (e) => {
            if(e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault(); e.stopPropagation();
                submitQty(parseInt(e.target.value));
            }
        });

        // 确定按钮
        document.getElementById('btn-qty-confirm').addEventListener('click', () => {
            submitQty(parseInt(document.getElementById('qty-custom-input').value));
        });

        function submitQty(val) {
            if (!val || val <= 0) { announce("无效数量"); return; }
            if (qtyCallback) qtyCallback(val);
            document.getElementById('modal-qty').classList.add('hidden');
        }

        function closeQtyModal() {
            document.getElementById('modal-qty').classList.add('hidden');
            closeModals();
        }

        window.closeModals = () => {
            document.querySelectorAll('[id^="modal-"]').forEach(m => m.classList.add('hidden'));
            if(currentScreen === 'takeout') {
                document.getElementById('takeout-list').querySelector('.item-card')?.focus();
            } else if(currentScreen === 'home') {
                document.getElementById('home-list').querySelector('.item-card')?.focus();
            }
        };

        // --- 更新逻辑 (取消操作支持) ---
        async function handleUpdate(change) {
            if (!currentActionItem) return;
            const newQty = currentActionItem.quantity + change;

            if (newQty === 0) {
                openZeroConfirm();
                return;
            }
            if (newQty < 0) {
                announce("库存不足"); return;
            }
            await execUpdate(change);
        }

        async function execUpdate(change) {
            try {
                await updateDoc(doc(db, "items", currentActionItem.id), {
                    quantity: increment(change),
                    updatedAt: serverTimestamp()
                });
                announce("更新成功");
                if (currentScreen === 'takeout') {
                    const input = document.getElementById('takeout-search');
                    input.value = ''; input.focus();
                } else {
                    closeModals();
                }
            } catch(e) { announce("失败"); }
        }

        function openZeroConfirm() {
            const m = document.getElementById('modal-zero');
            m.classList.remove('hidden');
            const keepBtn = document.getElementById('btn-zero-keep');
            keepBtn.focus();
            
            keepBtn.onclick = async () => {
                m.classList.add('hidden');
                await execUpdate(-currentActionItem.quantity); // 设为0
            };
            document.getElementById('btn-zero-del').onclick = async () => {
                m.classList.add('hidden');
                await execDelete();
            };
            // 增加：取消操作
            document.getElementById('btn-zero-cancel').onclick = () => {
                m.classList.add('hidden');
                announce("操作已撤销");
                closeModals();
            };
        }

        function openConfirm(item) {
            document.getElementById('modal-action').classList.add('hidden');
            const m = document.getElementById('modal-confirm');
            m.classList.remove('hidden');
            document.getElementById('confirm-text').textContent = item.name;
            document.getElementById('btn-confirm-del').onclick = execDelete;
            setTimeout(() => m.querySelector('button').focus(), 100);
        }

        async function execDelete() {
            try {
                await deleteDoc(doc(db, "items", currentActionItem.id));
                announce("已删除");
                closeModals();
                if (currentScreen === 'takeout') {
                    const input = document.getElementById('takeout-search');
                    input.value = ''; input.focus();
                }
            } catch(e) { announce("删除失败"); }
        }

        // --- 新增逻辑 ---
        document.getElementById('btn-add-qty-trigger').addEventListener('click', () => {
            openQtyPicker("设置数量", (v) => {
                pendingAddQty = v;
                updateAddQtyDisplay();
                document.getElementById('modal-qty').classList.add('hidden');
                document.getElementById('btn-add-qty-trigger').focus();
            });
        });

        function updateAddQtyDisplay() {
            document.getElementById('btn-add-qty-trigger').textContent = `数量：${pendingAddQty} (点击修改)`;
        }

        document.getElementById('form-add').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('add-name');
            try {
                await addDoc(itemsRef, {
                    name: nameInput.value,
                    room: document.getElementById('add-room').value,
                    location: document.getElementById('add-location').value,
                    quantity: pendingAddQty,
                    updatedAt: serverTimestamp()
                });
                announce(`已添加 ${nameInput.value}`);
                nameInput.value = '';
                document.getElementById('add-location').value = '';
                pendingAddQty = 1;
                updateAddQtyDisplay();
                nameInput.focus();
            } catch(e) { announce("失败"); }
        });

        // --- 数据导入/导出 ---
        // 导出 CSV
        document.getElementById('btn-export').addEventListener('click', () => {
            let csvContent = "\uFEFF物品名称,房间,具体位置,数量\n";
            allItems.forEach(item => {
                csvContent += `${item.name},${item.room},${item.location || ''},${item.quantity}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            const date = new Date().toISOString().slice(0,10);
            link.setAttribute("download", `物品备份_${date}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            announce("导出成功");
        });

        // 下载模板
        document.getElementById('btn-download-template').addEventListener('click', () => {
            const csvContent = "\uFEFF物品名称(必填),房间(必填),具体位置,数量(数字)\n大米,厨房,柜子,1\n洗衣液,卫生间,架子,2";
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `导入模板.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            announce("模板下载成功");
        });

        document.getElementById('btn-trigger-upload').addEventListener('click', () => {
            document.getElementById('file-upload').click();
        });

        document.getElementById('file-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const rows = text.split('\n');
                let count = 0;
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i].trim();
                    if (!row) continue;
                    const cols = row.split(',');
                    if (cols.length < 1) continue;
                    const name = cols[0]?.trim();
                    if(!name) continue;
                    await addDoc(itemsRef, {
                        name: name,
                        room: cols[1]?.trim() || '客厅',
                        location: cols[2]?.trim() || '',
                        quantity: parseInt(cols[3]) || 1,
                        updatedAt: serverTimestamp()
                    });
                    count++;
                }
                announce(`导入 ${count} 个物品`);
                // 导入完成后回到首页
                switchScreen('screen-home');
            };
            reader.readAsText(file);
        });

    </script>
</body>
</html>